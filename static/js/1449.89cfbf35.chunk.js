"use strict";(self.webpackChunkn2_trees=self.webpackChunkn2_trees||[]).push([[1449],{771:(e,t,i)=>{i.d(t,{I:()=>l});var s=i(6326),r=i(76460),n=i(50346),o=i(68134),a=(i(81806),i(47249),i(50076),i(87990));const l=e=>{const t=e;let i=class extends t{initialize(){this.addHandles((0,o.on)(()=>this.layer,"refresh",e=>{this.doRefresh(e.dataChanged).catch(e=>{(0,n.zf)(e)||r.A.getLogger(this).error(e)})}),"RefreshableLayerView")}};return i=(0,s.Cg)([(0,a.$)("esri.views.layers.RefreshableLayerView")],i),i}},12838:(e,t,i)=>{i.d(t,{jX:()=>c,zo:()=>p,gd:()=>h,ph:()=>a,no:()=>d,kz:()=>l,ht:()=>u,yo:()=>g});var s=i(19247);var r=i(59844);const n=new Map,o=new class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=e,this._interval=Math.min(e,t)}decreaseRefCount(e,t){const i=e+"/"+t,s=this._cachedBlocks;if(s.has(i)){const e=s.get(i);return e.refCount--,e.refCount<=0&&(s.delete(i),e.controller&&e.controller.abort()),e.refCount}return 0}getBlock(e,t){const i=e+"/"+t,s=this._cachedBlocks;if(s.has(i)){const e=s.get(i);return e.ts=Date.now(),e.refCount++,s.delete(i),s.set(i,e),e.block}return null}putBlock(e,t,i,s){const r=this._cachedBlocks,n=e+"/"+t;if(r.has(n)){const e=r.get(n);e.ts=Date.now(),e.refCount++}else r.set(n,{block:i,ts:Date.now(),refCount:1,controller:s});this._trim(),this._updateTimer()}deleteBlock(e,t){const i=this._cachedBlocks,s=e+"/"+t;i.has(s)&&i.delete(s)}updateMaxSize(e){this._size=e,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const e=this._cachedBlocks;this._timer=setInterval(()=>{const t=Array.from(e),i=Date.now();for(let s=0;s<t.length&&t[s][1].ts<=i-this._duration;s++)e.delete(t[s][0]);0===e.size&&this._clearTimer()},this._interval)}_trim(){const e=this._cachedBlocks;if(-1===this._size||this._size>=e.size)return;const t=Array.from(e);for(let i=0;i<t.length-this._size;i++)e.delete(t[i][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}};function a(e,t,i){const s=[];return null!=t&&s.push(`sliceId=${t}`),null!=i&&s.push(`bandIds=${i.join(",")}`),s.length?`${e}?${s.join("&")}`:e}function l(e,t){const i={extent:null,rasterInfo:t,cache:new Map},s=n.get(e);return s?(s.push(i),s.length-1):(n.set(e,[i]),0)}function u(e,t){const i=n.get(e);i&&(i[t]=null,i.some(e=>null!=e)||n.delete(e))}function c(e,t,i){const s=n.get(e);if(!s)return null==t?o.decreaseRefCount(e,i):0;if(null==t||null==s[t])return o.decreaseRefCount(e,i);const r=s[t]?.cache,a=r?.get(i);if(r&&a){if(a.refCount--,0===a.refCount){r.delete(i);for(let e=0;e<s.length;e++)s[e]?.cache.delete(i);a.controller&&a.controller.abort()}return a.refCount}return 0}function h(e,t,i){const s=n.get(e);if(!s)return null==t?o.getBlock(e,i):null;if(null==t||null==s[t]){for(let e=0;e<s.length;e++){const t=s[e]?.cache.get(i);if(t)return t.refCount++,t.block}return o.getBlock(e,i)}const r=s[t]?.cache.get(i);if(r)return r.refCount++,r.block;for(let n=0;n<s.length;n++){if(n===t||!s[n])continue;const e=s[n]?.cache,r=e?.get(i);if(e&&r)return r.refCount++,e.set(i,r),r.block}return null}function d(e,t,i,s){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const a=n.get(e);if(!a)return void(null==t&&o.putBlock(e,i,s,r));if(null==t||null==a[t])return void o.putBlock(e,i,s,r);const l={refCount:1,block:s,isResolved:!1,isRejected:!1,controller:r};s.then(()=>l.isResolved=!0).catch(()=>l.isRejected=!0),a[t]?.cache.set(i,l)}function p(e,t,i){const s=n.get(e);s?null!=t&&null!=s[t]?s[t]?.cache.delete(i):o.deleteBlock(e,i):null==t&&o.deleteBlock(e,i)}function m(e,t){const i=n.get(e);return i?i[t]??null:null}function g(e,t,i,n,o,a){let l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;const u=m(e,t);if(!u)return;const c=u.extent,{cache:h,rasterInfo:d}=u;if(c&&c.xmin===i.xmin&&c.xmax===i.xmax&&c.ymin===i.ymin&&c.ymax===i.ymax)return;n=n??0;const p=i.clone().normalize(),{spatialReference:g,transform:f}=d,y=new Set;for(let m=0;m<p.length;m++){const e=p[m];if(e.xmax-e.xmin<=n||e.ymax-e.ymin<=n)continue;let t=(0,r._l)(e,g,l);if(null==t)continue;if(null!=f&&(t=f.inverseTransform(t),null==t))continue;const i=new s.A({x:n,y:n,spatialReference:e.spatialReference});if(null==o&&!(o=(0,r.Wo)(i,g,e,l)))return;const{pyramidLevel:u,pyramidResolution:c,excessiveReading:h}=(0,r.t$)(o,d,a||"closest");if(h)return;const{storageInfo:x}=d,{origin:b}=x,{x:w,y:C}=c,_=Math.max(0,Math.floor((t.xmin-b.x)/w)),v=Math.max(0,Math.floor((b.y-t.ymax)/C)),T=Math.ceil(t.width/w-.1),P=Math.ceil(t.height/C-.1),S=u>0?x.pyramidBlockWidth:x.blockWidth,R=u>0?x.pyramidBlockHeight:x.blockHeight,M=x.blockBoundary[u];if(!M)continue;const z=1,k=Math.max(M.minCol,Math.floor(_/S)-z),F=Math.max(M.minRow,Math.floor(v/R)-z),I=Math.min(M.maxCol,Math.floor((_+T-1)/S)+z),B=Math.min(M.maxRow,Math.floor((v+P-1)/R)+z);for(let s=F;s<=B;s++)for(let e=k;e<=I;e++)y.add(`${u}/${s}/${e}`)}h.forEach((e,t)=>{if(!y.has(t)){const e=h.get(t);(null==e||e.isResolved||e.isRejected)&&h.delete(t)}}),u.extent={xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax}}},46550:(e,t,i)=>{i.d(t,{A:()=>l});var s=i(81806),r=i(36201),n=i(90548),o=i(44595);const a=(e,t)=>e.key.level-t.key.level!==0?e.key.level-t.key.level:e.key.row-t.key.row!==0?e.key.row-t.key.row:e.key.col-t.key.col;class l extends r.A{constructor(e){super(),this.tileInfoView=e,this.sortFunction=a}renderChildren(e){this.setStencilReference(e),super.renderChildren(e)}createRenderParams(e){const{state:t}=e,i=super.createRenderParams(e);return i.requiredLevel=this.tileInfoView.getClosestInfoForScale(t.scale).level,i.displayLevel=this.tileInfoView.tileInfo.scaleToZoom(t.scale),i}prepareRenderPasses(e){const t=super.prepareRenderPasses(e);return t.push(e.registerRenderPass({name:"stencil",brushes:[n.A],drawPhase:83,target:()=>this.getStencilTarget()})),(0,s.A)("esri-tiles-debug")&&t.push(e.registerRenderPass({name:"tileInfo",brushes:[o.A],drawPhase:64,target:()=>this.children})),t}getStencilTarget(){return this.children}setStencilReference(e){let t=1;for(const i of this.children)i.stencilRef=t++}}},60853:(e,t,i)=>{i.d(t,{K5:()=>h,Kt:()=>m,M8:()=>a,Rj:()=>g,_9:()=>o,i6:()=>d,mh:()=>c,nb:()=>u,p8:()=>x,tL:()=>l,xf:()=>f,yS:()=>p,y_:()=>w,zb:()=>y,zy:()=>b});var s=i(5095),r=i(60984),n=i(90113);function o(e){const t=(0,r.fV)(12.9898),i=(0,r.fV)(78.233),s=(0,r.fV)(43758.5453),n=(0,r.Om)(e,(0,r.Zc)(t,i)),o=(0,r.zi)(n,(0,r.fV)(3.14));return(0,r.jc)((0,r.F8)(o).multiply(s))}function a(e){return(0,r.LC)(e,(0,r.fV)(n.qM))}function l(e,t){return e.x.multiply(t.y).subtract(t.x.multiply(e.y))}function u(e){return e.multiply(2).subtract(1)}function c(e,t){const i=(0,r.fV)(2**t);return(0,r.zi)((0,r.RI)(e.divide(i)),(0,r.fV)(2))}function h(e,t){return(0,r.MM)(c(e,t),(0,r.fV)(.5))}function d(e,t){return c(e,t+s.U5)}function p(e,t){return c(e,t)}function m(e){const t=c(e.z,7),i=(0,r.fV)(1).subtract(t),s=e.xyz.subtract((0,r.eR)(0,0,(0,r.fV)(128)));return i.multiply(e).add(t.multiply(s))}function g(e){const t=(0,r.ln)(255/256,255/65536,255/16777216,255/4294967296);return(0,r.Om)(e,t)}function f(e){return(0,r.T9)((0,r.T9)((0,r.T9)(e.x,e.y),e.z),e.w)}function y(e){return new r.nt(1).subtract(e)}function x(e){return e.subtract(new r.nt(1))}function b(e,t){return e.subtract(new r.nt(t))}function w(e,t,i,s){let n=new r.Zb(0);const o=new r.Zb(0);return n=C(n,e,o),n=C(n,t,o),n=C(n,i,o),n=C(n,s,o),n}function C(e,t,i){const s=t.subtract(i),r=e.add(s);return i=r.subtract(e).subtract(s),r}},61229:(e,t,i)=>{i.d(t,{$Q:()=>a,Sd:()=>c,b5:()=>u,b7:()=>h});var s=i(31633),r=i(76797),n=i(19247),o=i(66486);async function a(e,t,s){if("extent"===s.type)return function(e,t,i){const{width:s,height:r}=e,n=new Uint8Array(s*r),a=t.width/s,l=t.height/r;if(i.width/a<.5||i.height/l<.5)return new o.A({pixelType:e.pixelType,width:s,height:r,mask:n,pixels:[...e.pixels]});const{xmin:u,xmax:c,ymin:h,ymax:d}=t,{xmin:p,xmax:m,ymin:g,ymax:f}=i,y=Math.max(u,p),x=Math.min(c,m),b=Math.max(h,g),w=Math.min(d,f),C=.5*a,_=.5*l;if(x-y<C||w-b<_||x<u+C||y>c-C||b>d-_||w<h+_)return new o.A({pixelType:e.pixelType,width:s,height:r,mask:n,pixels:[...e.pixels]});const v=Math.max(0,(y-u)/a),T=Math.min(s,Math.max(0,(x-u)/a)),P=Math.max(0,(d-w)/l),S=Math.min(r,Math.max(0,(d-b)/l)),R=Math.round(v),M=Math.round(T)-1,z=Math.round(P),k=Math.round(S)-1;if(R===M&&v%1>.5&&T%1<.5||z===k&&P%1>.5&&S%1<.5)return new o.A({pixelType:e.pixelType,width:s,height:r,mask:n,pixels:[...e.pixels]});if(0===R&&0===z&&M===s&&k===r)return e;const F=e.mask;for(let o=z;o<=k;o++)for(let e=R;e<=M;e++){const t=o*s+e;n[t]=F?F[t]:255}return new o.A({pixelType:e.pixelType,width:s,height:r,mask:n,pixels:[...e.pixels]})}(e,t,s);const{width:r,height:n}=e,a=new Uint8Array(r*n);return(await i.e(8165).then(i.bind(i,38165))).execute(t,s)?"polyline"===s.type?function(e,t,i){const{width:s,height:r}=e,n=new Uint8Array(s*r),a=t.width/s,l=t.height/r,{xmin:u,ymax:c}=t,{paths:h}=i,d=e.mask;for(let o=0;o<h.length;o++){const e=h[o];for(let t=0;t<e.length-1;t++){const[i,o]=e[t],[h,p]=e[t+1],m=Math.min(o,p),g=Math.max(o,p),f=Math.max(0,Math.floor((c-g)/l)),y=Math.min(r-1,Math.floor((c-m)/l));if(!(y<f))if(f===y){const e=Math.min(i,h),t=Math.max(i,h),r=Math.max(0,Math.floor((e-u)/a)),o=Math.min(s-1,Math.floor((t-u)/a));if(o<r)continue;const l=f*s;for(let i=l+r;i<=l+o;i++)n[i]=d?d[i]:255}else{const e=(i-u)/a,t=(h-i)/(p-o)/a,r=l*t;for(let i=f;i<=y;i++){const a=t*(c-i*l-o)+e,u=Math.max(0,Math.floor(r>0?a-r:a)),h=Math.min(s-1,Math.floor(r>0?a:a-r));if(h<u)continue;const p=i*s;for(let e=p+u;e<=p+h;e++)n[e]=d?d[e]:255}}}}return new o.A({pixelType:e.pixelType,width:s,height:r,mask:n,pixels:[...e.pixels]})}(e,t,s):(await i.e(2138).then(i.bind(i,32138))).execute(s,t)?e:l(e,t,s):new o.A({pixelType:e.pixelType,width:r,height:n,mask:a,maskIsAlpha:!1,pixels:[...e.pixels]})}function l(e,t,i){if(!e)return e;const{width:s,height:r}=e,n=u({geometry:i,size:[s,r],srcExtent:t,srcMask:e.mask});return new o.A({pixelType:e.pixelType,width:s,height:r,mask:n,maskIsAlpha:!1,pixels:[...e.pixels]})}function u(e){const{geometry:t,size:i,srcExtent:s,srcMask:r}=e,[n,o]=i;let a;const l=s.width/n,u=s.height/o,{xmin:c,ymax:h}=s;if("extent"===t.type){const e=(t.xmin-c)/l,i=(t.xmax-c)/l,s=(h-t.ymax)/u,r=(h-t.ymin)/u;a=[[[e,s],[e,r],[i,r],[i,s],[e,s]]]}else a=t.rings.map(e=>e.map(e=>{let[t,i]=e;return[(t-c)/l,(h-i)/u]}));return function(e,t,i){const[s,r]=t,n=new OffscreenCanvas(s,r).getContext("2d");n.fillStyle="#f00",n.beginPath(),e.forEach(e=>{n.moveTo(e[0][0],e[0][1]);for(let t=0;t<e.length;t++)n.lineTo(e[t][0],e[t][1]);n.closePath()}),n.fill();const o=n.getImageData(0,0,s,r).data,a=s*r,l=new Uint8Array(a);let u=!1;for(let c=0;c<a;c++)i&&!i[c]||(o[4*c+3]>127?l[c]=255:u=!0);return u||i?l:void 0}(a,i,r)}function c(e,t){const{extent:i}=h(e,t,new n.A({x:e.pixelSize.x,y:e.pixelSize.y,spatialReference:e.spatialReference})),{extent:s}=e.extent;if(i.xmax=Math.min(i.xmax,s.xmax),i.ymax=Math.min(i.ymax,s.ymax),i.xmin<i.xmax&&i.ymin<i.ymax){const{x:t,y:s}=e.pixelSize,r=Math.round(i.width/t),n=Math.round(i.height/s);e.extent=i,e.width=r,e.height=n}}function h(e,t,i){let n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const{spatialReference:o}=e,{x:a,y:l}=function(e,t){if(e.spatialReference.equals(t))return e;const i=(0,s.GA)(e.spatialReference),r=(0,s.GA)(t);if(i===r)return e;const n=i/r;return{x:e.x*n,y:e.y*n}}(i,o);let u,c,h;const d="extent"===t.type?t:t.extent;let{xmin:p,xmax:m,ymax:g,ymin:f}=d;const{xmin:y,ymax:x}=e.extent;return n?(p=y+(p>y?a*Math.round((p-y)/a):0),g=x-(g<x?l*Math.round((x-g)/l):0),m=y+(m>y?a*Math.round((m-y)/a):0),f=x-(f<x?l*Math.round((x-f)/l):0),u=new r.A({xmin:p,ymax:g,xmax:m,ymin:f,spatialReference:o}),c=Math.round(u.width/a),h=Math.round(u.height/l)):(c=Math.floor((m-p)/a+.8),h=Math.floor((g-f)/l+.8),p=y+(p>y?a*Math.floor((p-y)/a+.1):0),g=x-(g<x?l*Math.floor((x-g)/l+.1):0),m=p+c*a,f=g-h*l,u=new r.A({xmin:p,ymax:g,xmax:m,ymin:f,spatialReference:o})),{extent:u,width:c,height:h}}},71853:(e,t,i)=>{i.d(t,{WL:()=>u,b4:()=>o,hE:()=>l,kc:()=>a});i(72745);var s=i(93345),r=i(80895),n=i(96673);function o(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"nearest";const o=!(arguments.length>3&&void 0!==arguments[3]&&arguments[3]&&"u8"===t.pixelType),a=o?s.ld.FLOAT:s.ld.UNSIGNED_BYTE,l=null==t.pixels||0===t.pixels.length?null:o?t.getAsRGBAFloat():t.getAsRGBA(),u=e.capabilities.textureFloatLinear,c=new n.R(t.width,t.height);return c.internalFormat=o?s.H0.RGBA32F:6408,c.samplingMode=!u||"bilinear"!==i&&"cubic"!==i?9728:9729,c.dataType=a,c.wrapMode=33071,new r.g(e,c,l)}function a(e,t){const{spacing:i,offsets:o,coefficients:a,size:[l,u]}=t,c=i[0]>1,h=new n.R(c?4*l:l,u);h.internalFormat=s.H0.RGBA32F,h.dataType=s.ld.FLOAT,h.samplingMode=9728,h.wrapMode=33071;const d=new Float32Array(c?l*u*16:2*o.length);if(c&&null!=a)for(let s=0,r=0;s<a.length;s++)d[r++]=a[s],s%3==2&&(d[r++]=1);else for(let s=0;s<u;s++)for(let e=0;e<l;e++){const t=4*(s*l+e),i=2*(e*u+s);d[t]=o[i],d[t+1]=o[i+1],d[t+3]=-1===o[i]?0:1}return new r.g(e,h,d)}function l(e,t){const i=new n.R(t.length/4,1);return i.internalFormat=6408,i.samplingMode=9728,i.wrapMode=33071,new r.g(e,i,t)}function u(e,t,i){const o=new n.R(i[0],i[1]);return o.internalFormat=6406,o.pixelFormat=6406,o.dataType=s.ld.UNSIGNED_BYTE,o.samplingMode=9728,o.wrapMode=33071,new r.g(e,o,t)}},81892:(e,t,i)=>{i.d(t,{r:()=>n});var s=i(60984);function r(e){const t=function(e){const t=new s.nt(1/6),i=e.multiply(e),r=i.multiply(e),n=t.multiply(r.multiply(-1).add(new s.nt(3).multiply(i)).subtract(new s.nt(3).multiply(e)).add(1)),o=t.multiply(r.multiply(3).subtract(i.multiply(6)).add(4)),a=t.multiply(r.multiply(-3).add(i.multiply(3)).add(e.multiply(3)).add(1)),l=t.multiply(r);return new s.Zb(n,o,a,l)}(e),i=t.x.add(t.y),r=t.z.add(t.w),n=new s.nt(1).subtract(t.y.divide(i)).add(e),o=new s.nt(1).add(t.w.divide(r)).subtract(e);return new s.Zb(n,o,i,r)}function n(e,t,i){const n=new s.ZY(new s.nt(1).divide(i.x),0),o=new s.ZY(0,new s.nt(1).divide(i.y)),a=t.multiply(i).subtract(.5),l=r((0,s.jc)(a).x).xyz,u=r((0,s.jc)(a).y).xyz;let c=t.add(l.x.multiply(n)),h=t.subtract(l.y.multiply(n));const d=c.add(u.x.multiply(o)),p=h.add(u.x.multiply(o));c=c.subtract(u.y.multiply(o)),h=h.subtract(u.y.multiply(o));let m=(0,s.US)(e,h),g=(0,s.US)(e,c);const f=(0,s.US)(e,p),y=(0,s.US)(e,d);return m=(0,s.jh)(m,f,u.z),g=(0,s.jh)(g,y,u.z),m=(0,s.jh)(m,g,l.z),m}},90113:(e,t,i)=>{i.d(t,{$w:()=>u,Fb:()=>o,Fz:()=>g,J5:()=>a,M:()=>h,Ni:()=>c,V5:()=>n,Xx:()=>m,YV:()=>w,au:()=>l,b5:()=>y,bB:()=>T,bg:()=>x,cZ:()=>_,cn:()=>p,eo:()=>C,kx:()=>f,os:()=>s,qM:()=>d,rp:()=>r,ti:()=>b,v9:()=>v});const s=3.14159265359/180,r=3.14159265359/128,n=1,o=1.1,a=1,l=24,u=8,c=1e-5,h=.05,d=1e-30,p=4,m=0,g=2,f=2,y=3,x=0,b=3,w=16777216,C=1.1,_=16,v=128,T=1},90356:(e,t,i)=>{i.d(t,{i:()=>s});const s={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}},91449:(e,t,i)=>{i.r(t),i.d(t,{default:()=>ki});var s=i(6326),r=i(54901),n=i(76460),o=i(50346),a=i(68134),l=i(46053),u=i(81806),c=(i(47249),i(87990)),h=i(68347),d=i(64022),p=i(56286),m=i(69539),g=i(15941),f=i(17775),y=i(52297),x=i(61229),b=i(52494),w=i(2413),C=i(28632),_=i(85827),v=i(30726),T=i(86300),P=i(59422),S=i(8794),R=i(71853);const M={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class z extends S.q{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;super(),this._textureInvalidated=!0,this._colormapTextureInvalidated=!0,this._rasterTexture=null,this._maskTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,this._colormapTexture=null,this._colormap=null,this._supportsBilinearTexture=!0,this._processedTexture=null,this._highlightTexture=null,this.functionTextures=[],this.projected=!1,this.stencilRef=0,this.coordScale=[1,1],this._processed=!1,this._highlighted=!1,this._symbolizerParameters=null,this.height=null,this.isRendereredSource=!1,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this._mask=null,this.rawPixelData=null,this._suspended=!1,this._bandIds=null,this._interpolation=null,this._transformGrid=null,this.width=null,this.x=0,this.y=0,this.source=e,this.transformGrid=t,this.interpolation=i}destroy(){super.destroy(),this._disposeTextures()}get processedTexture(){return this._processedTexture}set processedTexture(e){this._processedTexture!==e&&(this._disposeTextures(!0),this._processedTexture=e)}get highlightTexture(){return this._highlightTexture}set highlightTexture(e){this._highlightTexture!==e&&(this._highlightTexture?.dispose(),this._highlightTexture=e),null==e&&(this._highlighted=!1)}get rasterTexture(){return this._rasterTexture}set rasterTexture(e){this._rasterTexture!==e&&(this._rasterTexture?.dispose(),this._rasterTexture=e),null==e&&(this.projected=!1)}get processed(){return this._processed}set processed(e){this._processed=e,e||(this.processedTexture=(0,v.WD)(this.processedTexture),this.invalidateTexture())}get highlighted(){return this._highlighted}get symbolizerParameters(){return this._symbolizerParameters||M}set symbolizerParameters(e){this._symbolizerParameters!==e&&(this._symbolizerParameters=e,this._colormapTextureInvalidated=!0)}get source(){return this._source}set source(e){this._source!==e&&(this._source=e,this._rasterTexture&&(this._rasterTexture=(0,v.WD)(this._rasterTexture),this._rasterTextureBandIds=null),this.projected=!1,this.invalidateTexture())}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._maskTexture=(0,v.WD)(this._maskTexture))}get suspended(){return this._suspended}set suspended(e){this._suspended&&!e&&this.stage&&(this.ready(),this.requestRender()),this._suspended=e}get bandIds(){return this._bandIds}set bandIds(e){this._bandIds=e,this._isBandIdsChanged(e)&&(this.projected=!1,this.invalidateTexture())}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){this._interpolation=e,this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===this._getTextureSamplingMethod(e||"nearest")?9729:9728)}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid!==e&&(this._transformGrid=e,this._transformGridTexture=(0,v.WD)(this._transformGridTexture))}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())}getRasterTextureSize(){const e=arguments.length>0&&void 0!==arguments[0]&&arguments[0]||this.projected;return[e?this.width:this.source?.width||this.width,e?this.height:this.source?.height||this.height]}getRasterCellSize(){const e=this.rawPixelData?.srcPixelSize,{projected:t,resolution:i}=this;return e&&!t?[e.x,e.y]:[i,i]}_createTransforms(){return{displayViewScreenMat3:(0,_.vt)()}}setTransform(e){const t=(0,T.D_)(this.transforms.displayViewScreenMat3),[i,s]=e.toScreenNoRotation([0,0],[this.x,this.y]),r=this.resolution/this.pixelRatio/e.resolution,n=r*this.width,o=r*this.height,a=Math.PI*this.rotation/180;(0,T.Tl)(t,t,(0,P.fA)(i,s)),(0,T.Tl)(t,t,(0,P.fA)(n/2,o/2)),(0,T.e$)(t,t,-a),(0,T.Tl)(t,t,(0,P.fA)(-n/2,-o/2)),(0,T.Oe)(t,t,(0,P.fA)(n,o)),(0,T.lw)(this.transforms.displayViewScreenMat3,e.displayViewMat3,t)}getTextures(){let{forProcessing:e=!1,useProcessedTexture:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const i=t?this._processedTexture??this._rasterTexture:this._rasterTexture,s=[],r=[];return i?(this._transformGridTexture&&!this.projected&&(r.push(this._transformGridTexture),s.push("u_transformGrid")),r.push(i),s.push("u_image"),!this._colormapTexture||!t&&e||(r.push(this._colormapTexture),s.push("u_colormap")),this._maskTexture&&(r.push(this._maskTexture),s.push("u_mask")),{names:s,textures:r}):{names:s,textures:r}}onAttach(){this.invalidateTexture()}onDetach(){this.invalidateTexture()}updateTexture(e){let{context:t}=e;if(!this.stage)return void this._disposeTextures();const i=this._isValidSource(this.source);i&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(t)),this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(t),this._rasterTexture&&(i?(this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=(0,R.kc)(t,this.transformGrid)),this._mask&&!this._maskTexture&&(this._maskTexture=(0,R.WL)(t,this._mask,[this.width,this.height]))):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()))}updateProcessedTexture(){(!(arguments.length>0&&void 0!==arguments[0])||arguments[0])&&(this._highlighted=null!=this.highlightTexture);const{functionTextures:e}=this;0!==e.length&&(this.processedTexture=e.shift(),e.forEach(e=>e?.dispose()),e.length=0,this.processed=!!this.processedTexture)}_createOrDestroyRasterTexture(e){const t=this.source?.extractBands(this.bandIds);if(!this._isValidSource(t))return void(this._rasterTexture&&(this._rasterTexture=(0,v.WD)(this._rasterTexture),this._rasterTextureBandIds=null));const i=!this._isBandIdsChanged(this.bandIds);if(this._rasterTexture){if(i)return;this._rasterTexture=(0,v.WD)(this._rasterTexture),this._rasterTextureBandIds=null}this._supportsBilinearTexture=!!e.capabilities.textureFloatLinear;const s=this._getTextureSamplingMethod(this.interpolation),r=this.isRendereredSource;this._rasterTexture=(0,R.b4)(e,t,s,r),this.projected=!1,this._processed=!1,this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}_isBandIdsChanged(e){const t=this._rasterTextureBandIds;return!(null==t&&null==e||t&&e&&t.join("")===e.join(""))}_isValidSource(e){return null!=e&&e.pixels?.length>0}_getTextureSamplingMethod(e){const{type:t}=this.symbolizerParameters,i="lut"===t&&!this.symbolizerParameters.isClassBreaks||"hillshade"===t||"stretch"===t&&1===this.symbolizerParameters.bandCount;return!this._supportsBilinearTexture||i||"bilinear"!==e&&"cubic"!==e?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some((e,i)=>e!==t[i])?(this._colormapTexture&&(this._colormapTexture=(0,v.WD)(this._colormapTexture)),this._colormapTexture=(0,R.hE)(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=(0,R.hE)(e,i),void(this._colormap=i)):(this._colormapTexture&&(this._colormapTexture=(0,v.WD)(this._colormapTexture)),void(this._colormap=null))}_disposeTextures(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]?this.projected&&(this._transformGridTexture=(0,v.WD)(this._transformGridTexture)):(this._rasterTexture=(0,v.WD)(this._rasterTexture),this._colormapTexture=(0,v.WD)(this._colormapTexture),this._transformGridTexture=(0,v.WD)(this._transformGridTexture),this._maskTexture=(0,v.WD)(this._maskTexture),this._rasterTextureBandIds=null,this._colormap=null,this._colormapTextureInvalidated=!0),this._processedTexture=(0,v.WD)(this._processedTexture),this._highlightTexture=(0,v.WD)(this._highlightTexture)}}var k=i(78440);class F extends k.Y{constructor(e,t,i,s,r,n){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;super(e,t,i,s,r,n),this.bitmap=null,this.bitmap=new z(o,null,null),this.bitmap.coordScale=[r,n],this.bitmap.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(e){this.bitmap.stencilRef=e}get stencilRef(){return this.bitmap.stencilRef}setTransform(e){super.setTransform(e),this.bitmap.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}_createTransforms(){return{displayViewScreenMat3:(0,_.vt)(),tileMat3:(0,_.vt)()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}}var I=i(46550),B=i(70479),A=i(90356),D=i(6951),O=i(60984),Z=i(60853);class V extends D.ZA{}(0,s.Cg)([(0,D.C5)(0,O.ZY)],V.prototype,"position",void 0);class q extends D.HS{}class U extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.z7)],U.prototype,"inputTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],U.prototype,"sumTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],U.prototype,"numOfNoDataTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],U.prototype,"numTexels",void 0);class E extends D.A{constructor(){super(...arguments),this.type="TextureStatisticsDiffShader"}vertex(e){const t=e.position;return{uv:t,glPosition:new O.Zb((0,Z.nb)(t),0,1)}}fragment(e){const{inputTexture:t,numOfNoDataTexture:i,sumTexture:s}=this.config,r=new D.mm,n=(0,O.US)(t,e.uv),o=(0,O.nP)(s,new O.Cq(0,0),new O.Ai(0)),a=(0,O.nP)(i,new O.Cq(0,0),new O.Ai(0)).r,l=this.config.numTexels.subtract(a),u=o.divide(l),c=(0,O.PM)(n.a,new O.nt(0)),h=new O.nt(1).subtract(c).multiply(n.subtract(u));return r.fragColor=h.multiply(h),r}}(0,s.Cg)([(0,D.Pi)(U)],E.prototype,"config",void 0),(0,s.Cg)([(0,s.Qj)(0,(0,D.hF)(V))],E.prototype,"vertex",null),(0,s.Cg)([(0,s.Qj)(0,(0,D.hF)(q))],E.prototype,"fragment",null);var j=i(90113);class G extends D.ZA{}(0,s.Cg)([(0,D.C5)(0,O.ZY)],G.prototype,"position",void 0);class L extends D.HS{}class H extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.z7)],H.prototype,"minTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],H.prototype,"maxTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],H.prototype,"sumTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],H.prototype,"numOfNoDataTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.Ai)],H.prototype,"width",void 0),(0,s.Cg)([(0,D.Pi)(O.Ai)],H.prototype,"height",void 0),(0,s.Cg)([(0,D.Pi)(O.Ai)],H.prototype,"isFirstPass",void 0);class W extends D.A{constructor(){super(...arguments),this.type="TextureStatisticsMinMaxSumShader"}vertex(e){const t=e.position;return{uv:t,glPosition:new O.Zb((0,Z.nb)(t),0,1)}}fragment(e){const t=new D.mm,{minTexture:i,maxTexture:s,sumTexture:r,numOfNoDataTexture:n}=this.config,o=e.glFragCoord.xy,a=new O.Cq(o.multiply(2)),l=new O.Ai(0),u=(0,O.nP)(i,a,l),c=(0,O.nP)(i,a.add(new O.Cq(-1,0)),l),h=(0,O.nP)(i,a.add(new O.Cq(0,-1)),l),d=(0,O.nP)(i,a.add(new O.Cq(-1,-1)),l),p=Y(Y(u,Y(c,new O.Zb(j.YV))),Y(h,Y(d,new O.Zb(j.YV)))),m=(0,O.nP)(s,a,l),g=(0,O.nP)(s,a.add(new O.Cq(-1,0)),l),f=(0,O.nP)(s,a.add(new O.Cq(0,-1)),l),y=(0,O.nP)(s,a.add(new O.Cq(-1,-1)),l),x=N(N(m,N(g,new O.Zb(-j.YV))),N(f,N(y,new O.Zb(-j.YV)))),b=(0,O.nP)(r,a,l),w=(0,O.nP)(r,a.add(new O.Cq(-1,0)),l),C=(0,O.nP)(r,a.add(new O.Cq(0,-1)),l),_=(0,O.nP)(r,a.add(new O.Cq(-1,-1)),l),v=(0,Z.y_)(Q(b),Q(w),Q(C),Q(_)),T=(0,O.nP)(n,a,l),P=(0,O.nP)(n,a.add(new O.Cq(-1,0)),l),S=(0,O.nP)(n,a.add(new O.Cq(0,-1)),l),R=(0,O.nP)(n,a.add(new O.Cq(-1,-1)),l),M=new O.nt(this.config.isFirstPass),z=(0,Z.y_)($(T,M),$(P,M),$(S,M),$(R,M));return t.fragData0=p,t.fragData1=x,t.fragData2=v,t.fragData3=z,t}}function Y(e,t){const i=(0,O.PM)(e.a,new O.nt(0));return(0,O.jk)(e,t).multiply(new O.nt(1).subtract(i)).add(t.multiply(i))}function N(e,t){const i=(0,O.PM)(e.a,new O.nt(0));return(0,O.T9)(e,t).multiply(new O.nt(1).subtract(i)).add(t.multiply(i))}function Q(e){const t=(0,O.PM)(e.a,new O.nt(0)),i=new O.nt(1).subtract(t);return e.multiply(i)}function $(e,t){const i=(0,O.PM)(e.a,new O.nt(0)),s=new O.nt(1).subtract(t);return t.multiply(i).multiply(new O.Zb(1)).add(s.multiply(e))}(0,s.Cg)([(0,D.Pi)(H)],W.prototype,"config",void 0),(0,s.Cg)([(0,s.Qj)(0,(0,D.hF)(G))],W.prototype,"vertex",null),(0,s.Cg)([(0,s.Qj)(0,(0,D.hF)(L))],W.prototype,"fragment",null);class K extends D.ZA{}(0,s.Cg)([(0,D.C5)(0,O.ZY)],K.prototype,"position",void 0);class X extends D.HS{}class J extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.z7)],J.prototype,"minTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],J.prototype,"maxTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],J.prototype,"sumTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],J.prototype,"numOfNoDataTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],J.prototype,"diffSqTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],J.prototype,"numTexels",void 0);class ee extends D.A{constructor(){super(...arguments),this.type="TextureStatisticsStdDevShader"}vertex(e){const t=e.position;return{uv:t,glPosition:new O.Zb((0,Z.nb)(t),0,1)}}fragment(e){const t=new D.mm,{minTexture:i,maxTexture:s,numOfNoDataTexture:r,sumTexture:n,diffSqTexture:o}=this.config,a=e.glFragCoord.xy,l=new O.Cq(a),u=new O.Ai(0),c=(0,O.nP)(i,l,u),h=(0,O.nP)(s,l,u),d=(0,O.nP)(n,l,u),p=(0,O.nP)(r,l,u).r,m=(0,O.nP)(o,l,u),g=this.config.numTexels.subtract(p),f=d.divide(g),y=m.divide(g),x=(0,O.RZ)(y);return t.fragData0=c,t.fragData1=h,t.fragData2=f,t.fragData3=x,t}}(0,s.Cg)([(0,D.Pi)(J)],ee.prototype,"config",void 0),(0,s.Cg)([(0,s.Qj)(0,(0,D.hF)(K))],ee.prototype,"vertex",null),(0,s.Cg)([(0,s.Qj)(0,(0,D.hF)(X))],ee.prototype,"fragment",null);class te extends D.ZA{}(0,s.Cg)([(0,D.C5)(0,O.ZY)],te.prototype,"position",void 0);class ie extends D.HS{}class se extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.z7)],se.prototype,"sumTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.Ai)],se.prototype,"width",void 0),(0,s.Cg)([(0,D.Pi)(O.Ai)],se.prototype,"height",void 0);class re extends D.A{constructor(){super(...arguments),this.type="TextureStatisticsSumOfSquaredDiffShader"}vertex(e){const t=e.position;return{uv:t,glPosition:new O.Zb((0,Z.nb)(t),0,1)}}fragment(e){const t=new D.mm,{sumTexture:i}=this.config,s=e.glFragCoord.xy,r=new O.Cq(s.multiply(2)),n=new O.Ai(0),o=(0,O.nP)(i,r,n),a=(0,O.nP)(i,r.add(new O.Cq(-1,0)),n),l=(0,O.nP)(i,r.add(new O.Cq(0,-1)),n),u=(0,O.nP)(i,r.add(new O.Cq(-1,-1)),n),c=(0,Z.y_)(o,a,l,u);return t.fragData0=c,t.fragData1=new O.Zb(0),t.fragData2=new O.Zb(0),t.fragData3=new O.Zb(0),t}}(0,s.Cg)([(0,D.Pi)(se)],re.prototype,"config",void 0),(0,s.Cg)([(0,s.Qj)(0,(0,D.hF)(te))],re.prototype,"vertex",null),(0,s.Cg)([(0,s.Qj)(0,(0,D.hF)(ie))],re.prototype,"fragment",null);var ne=i(9685),oe=i(93345),ae=i(12331),le=i(80895),ue=i(96673);const ce=1048576;class he extends B.j{constructor(){super(...arguments),this.type=32,this._width=0,this._height=0,this._framebuffers=null,this._minTexture=null,this._maxTexture=null,this._sumTexture=null,this._numOfNoDataTexture=null,this._resultsFramebuffer=null,this._startFramebuffer=null,this._diffFramebuffer=null,this._scaleFbo=null,this.shaders={textureStatisticsMinMaxSum:new W,textureStatisticsSum:new re,textureStatisticsDiff:new E,textureStatisticsStdDev:new ee}}dispose(){this.shaders.textureStatisticsMinMaxSum=null,this._framebuffers&&(this._framebuffers.forEach(e=>(0,v.WD)(e)),this._framebuffers=null),(0,v.WD)(this._resultsFramebuffer),(0,v.WD)(this._startFramebuffer),(0,v.WD)(this._diffFramebuffer),(0,v.WD)(this._scaleFbo),(0,v.WD)(this._minTexture),(0,v.WD)(this._maxTexture),(0,v.WD)(this._sumTexture),(0,v.WD)(this._numOfNoDataTexture)}get minValuesTexture(){return this._minTexture||null}get maxValuesTexture(){return this._maxTexture||null}get meanValuesTexture(){return this._resultsFramebuffer?.getColorTexture(oe.Fq)||null}get stdDevValuesTexture(){return this._resultsFramebuffer?.getColorTexture(oe.M4)||null}get statsFbo(){return this._resultsFramebuffer}render(e,t){const{context:i,painter:s}=e;let r=t.fbo.width,n=t.fbo.height,o=t.fbo;const a=i.gl,l=i.getBoundFramebufferObject();if(r*n>ce||!(0,g.r6)(r)||!(0,g.r6)(n)){const e=r/n;if(r*n>ce){const t=Math.max(Math.floor(Math.sqrt(ce/e)),1);r=Math.max(Math.floor(e*t),1),n=t}if((0,g.r6)(r)||(r=ge(r)),(0,g.r6)(n)||(n=ge(n)),this._scaleFbo)this._scaleFbo.resize(r,n);else{const{dataType:e,internalFormat:s}=t.fbo.getColorTexture(oe.r6).descriptor,o=s??oe.H0.RGBA8;this._scaleFbo=pe(i,r,n,e,o)}i.bindFramebuffer(this._scaleFbo),i.setViewport(0,0,r,n),s.blitTexture(i,o.getColorTexture(oe.r6),9728),o=this._scaleFbo}this._updateResources(e,o),s.setPipelineState({...A.i,color:{write:[!0,!0,!0,!0],blendMode:"none"}});const u=this._applyReductionPass(e);a.readBuffer(a.COLOR_ATTACHMENT3),u.copyToTexture(0,0,1,1,0,0,this._numOfNoDataTexture),a.readBuffer(a.COLOR_ATTACHMENT2),u.copyToTexture(0,0,1,1,0,0,this._sumTexture),a.readBuffer(a.COLOR_ATTACHMENT1),u.copyToTexture(0,0,1,1,0,0,this._maxTexture),a.readBuffer(a.COLOR_ATTACHMENT0),u.copyToTexture(0,0,1,1,0,0,this._minTexture);const c=t.fbo.getColorTexture(oe.r6);if(!c)throw new Error("Start buffer color texture is not available, cannot compute diff.");this._computeDiff(e,c,this._sumTexture,this._numOfNoDataTexture,r,n);const h=this._applySecondReductionPass(e,r,n).getColorTexture(oe.r6);this._computeSdtDev(e,this._minTexture,this._maxTexture,this._sumTexture,this._numOfNoDataTexture,h,r,n),i.bindFramebuffer(l),i.setViewport(0,0,t.fbo.width,t.fbo.height),i.setDrawBuffers([oe.r6]),s.setPipelineState(A.i)}_applyReductionPass(e){const{context:t,painter:i}=e,s=this.shaders.textureStatisticsMinMaxSum,r=this._framebuffers;if(null===r)throw new Error("Framebuffers are not initialized, cannot apply reduction pass.");t.setDrawBuffers([oe.r6,oe.yI,oe.Fq]);const n=this._startFramebuffer;let o=n.getColorTexture(oe.r6),a=n.getColorTexture(oe.yI),l=n.getColorTexture(oe.Fq),u=n.getColorTexture(oe.M4);const c=r;let h=0;for(const d of c){t.setViewport(0,0,d.width,d.height),t.bindFramebuffer(d),t.setClearColor(0,0,0,0),t.clear(16384);const e={shader:s,uniforms:{config:{minTexture:{texture:o,unit:1},maxTexture:{texture:a,unit:2},sumTexture:{texture:l,unit:3},numOfNoDataTexture:{texture:u,unit:4},width:d.width,height:d.height,isFirstPass:0===h?1:0}},defines:null,optionalAttributes:null,useComputeBuffer:!1};i.submitDrawMesh(t,e,i.quadMesh),o=d.getColorTexture(oe.r6),a=d.getColorTexture(oe.yI),l=d.getColorTexture(oe.Fq),u=d.getColorTexture(oe.M4),h++}return r.at(-1)}_applySecondReductionPass(e,t,i){const{context:s,painter:r}=e,n=this.shaders.textureStatisticsSum,o=this._framebuffers;if(null===o||null==this._diffFramebuffer)throw new Error("Framebuffers are not initialized, cannot apply reduction pass.");s.setDrawBuffers([oe.r6]);let a=this._diffFramebuffer.getColorTexture(oe.r6);const l=o;for(const u of l){s.setViewport(0,0,u.width,u.height),s.bindFramebuffer(u),s.setClearColor(0,0,0,0),s.clear(16384);const e={shader:n,uniforms:{config:{sumTexture:{texture:a,unit:2},width:u.width,height:u.height}},defines:null,optionalAttributes:null,useComputeBuffer:!1};r.submitDrawMesh(s,e,r.quadMesh),a=u.getColorTexture(oe.r6)}return o.at(-1)}_updateResources(e,t){const{context:i}=e,s=t.width,r=t.height;if(null===this._startFramebuffer){if(!(0,ne.C)().supportsColorBufferFloat)throw new Error("WebGL does not support color buffer float, cannot compute texture statistics.");const e=t.getColorTexture(oe.r6);if(!e)throw new Error("Input FBO does not have a color attachment 0, cannot compute texture statistics.");const n=e.descriptor,{dataType:o,internalFormat:a}=n,l=pe(i,s,r,o,a??oe.H0.RGBA8,4),u=l.getColorTexture(oe.r6),c=l.getColorTexture(oe.yI),h=l.getColorTexture(oe.Fq),d=l.getColorTexture(oe.M4);t.copyToTexture(0,0,s,r,0,0,u),t.copyToTexture(0,0,s,r,0,0,c),t.copyToTexture(0,0,s,r,0,0,h),t.copyToTexture(0,0,s,r,0,0,d),this._startFramebuffer=l,this._diffFramebuffer=pe(i,s,r,oe.ld.FLOAT,oe.H0.RGBA32F),this._resultsFramebuffer=pe(i,1,1,oe.ld.FLOAT,oe.H0.RGBA32F,4),this._minTexture=me(i,1,1,oe.ld.FLOAT,oe.H0.RGBA32F),this._maxTexture=me(i,1,1,oe.ld.FLOAT,oe.H0.RGBA32F),this._sumTexture=me(i,1,1,oe.ld.FLOAT,oe.H0.RGBA32F),this._numOfNoDataTexture=me(i,1,1,oe.ld.FLOAT,oe.H0.R32F)}else{const e=this._startFramebuffer;e.resize(s,r);const i=e.getColorTexture(oe.r6),n=e.getColorTexture(oe.yI),o=e.getColorTexture(oe.Fq),a=e.getColorTexture(oe.M4);t.copyToTexture(0,0,s,r,0,0,i),t.copyToTexture(0,0,s,r,0,0,n),t.copyToTexture(0,0,s,r,0,0,o),t.copyToTexture(0,0,s,r,0,0,a),this._diffFramebuffer.resize(s,r)}if(this._width===s&&this._height===r&&null!==this._framebuffers)return;const n=(this._framebuffers||[]).reverse();this._framebuffers=null,this._width=s,this._height=r,this._framebuffers=this._updateFramebuffers(i,s,r,n,4)}_updateFramebuffers(e,t,i,s){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;const n=[];let o=t,a=i;for(;o>1||a>1;){const t=Math.max(1,Math.floor(o/2)),i=Math.max(1,Math.floor(a/2)),l=de(e,t,i,s,r);n.push(l),o=t,a=i}return n.at(-1),s.forEach(e=>(0,v.WD)(e)),s.length=0,n}_computeDiff(e,t,i,s,r,n){const{context:o,painter:a}=e;o.bindFramebuffer(this._diffFramebuffer),o.setDrawBuffers([oe.r6]),o.setViewport(0,0,r,n),o.setClearColor(0,0,0,0),o.clear(16384);const l={shader:this.shaders.textureStatisticsDiff,uniforms:{config:{inputTexture:{texture:t,unit:1},sumTexture:{texture:i,unit:2},numOfNoDataTexture:{texture:s,unit:3},numTexels:r*n}},defines:null,optionalAttributes:null,useComputeBuffer:!1};a.submitDrawMesh(o,l,a.quadMesh)}_computeSdtDev(e,t,i,s,r,n,o,a){const{context:l,painter:u}=e;l.bindFramebuffer(this._resultsFramebuffer),l.setDrawBuffers([oe.r6,oe.yI,oe.Fq,oe.M4]),l.setViewport(0,0,1,1),l.setClearColor(0,0,0,0),l.clear(16384);const c={shader:this.shaders.textureStatisticsStdDev,uniforms:{config:{minTexture:{texture:t,unit:1},maxTexture:{texture:i,unit:2},sumTexture:{texture:s,unit:3},numOfNoDataTexture:{texture:r,unit:4},diffSqTexture:{texture:n,unit:5},numTexels:o*a}},defines:null,optionalAttributes:null,useComputeBuffer:!1};u.submitDrawMesh(l,c,u.quadMesh)}}function de(e,t,i,s){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,n=s.pop();return void 0!==n?n.resize(t,i):n=pe(e,t,i,oe.ld.FLOAT,oe.H0.RGBA32F,r),n}function pe(e,t,i,s,r){let n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;if(n<1||n>4)throw new Error("Number of color attachments must be between 1 and 4.");const o=new ae.H(e,me(e,t,i,s,r));for(let a=1;a<n;a++){const n=me(e,t,i,s,r);o.attachColorTexture(n,oe.r6+a)}return o}function me(e,t,i,s,r){const n=new ue.R(t,i);return n.samplingMode=9728,n.wrapMode=33071,n.pixelFormat=6408,n.dataType=s,n.internalFormat=r,new le.g(e,n)}function ge(e){const t=(0,g.yR)(e),i=t/2;return Math.abs(t-e)<Math.abs(i-e)?t:i}function fe(e,t){const i=new ue.R(e,t);return i.internalFormat=oe.H0.RGBA32F,i.samplingMode=9728,i.dataType=oe.ld.FLOAT,i.isImmutable=!0,i.wrapMode=33071,i}function ye(e,t,i){const s=fe(t,i);return new le.g(e,s)}function xe(e,t,i){const s=fe(t,i);return new ae.H(e,s)}function be(e){const{symbolizerParameters:t}=e,{type:i}=t,s="lut"===i?"nearest":e.interpolation,r="bilinear"===s&&"lut"!==i&&("stretch"!==i||1===t.bandCount);return{bilinear:r,bicubic:"cubic"===s,nearestOnEdge:r}}var we=i(81892);class Ce extends D.k2{}function _e(e,t){const{transformTexture:i,targetImageSize:s,transformSpacing:r}=t,n=(0,O.RI)(e.multiply(s)),o=new O.ZY(4,1),a=(0,O.RI)(n.divide(r)).multiply(o),l=(0,O.jc)(n.add(new O.ZY(.5,.5)).divide(r)),u=new O.Cq((0,O.Wh)(a.x),(0,O.Wh)(a.y)),c=new O.eB(l,1);return(0,O.Tk)((0,O.$5)(l.x,l.y),function(e,t,i){const s=(0,O.nP)(e,t,new O.Ai(0)),r=new O.Cq(t.x.add(1),t.y),n=(0,O.nP)(e,r,new O.Ai(0));return new O.ZY((0,O.Om)(s.rgb,i),(0,O.Om)(n.rgb,i))}(i,u,c),function(e,t,i){const s=new O.Cq(t.x.add(2),t.y),r=(0,O.nP)(e,s,new O.Ai(0)),n=new O.Cq(t.x.add(3),t.y),o=(0,O.nP)(e,n,new O.Ai(0));return new O.ZY((0,O.Om)(r.rgb,i),(0,O.Om)(o.rgb,i))}(i,u,c))}function ve(e,t){return t?arguments.length>2&&void 0!==arguments[2]&&arguments[2]?function(e,t){const i=(0,O.US)(t.transformTexture,e);return new O.ZY(i.r,i.g)}(e,t):_e(e,t):e}function Te(e,t,i){const{bicubic:s=!1,bilinear:r=!1,nearestOnEdge:n=!1}=i??{};return s||r?s?(0,we.r)(t.texture,e,t.srcImageSize):function(e,t,i,s){const r=(0,O.RI)(t.multiply(i)),n=new O.Cq(new O.Ai(r.x),new O.Ai(r.y)),o=new O.Cq(n.x.add(1),n.y),a=new O.Cq(n.x,n.y.add(1)),l=new O.Cq(n.x.add(1),n.y.add(1)),u=(0,O.nP)(e,n,new O.Ai(0)),c=(0,O.nP)(e,o,new O.Ai(0)),h=(0,O.nP)(e,a,new O.Ai(0)),d=(0,O.nP)(e,l,new O.Ai(0)),p=(0,O.jc)(t.multiply(i)),m=(0,O.jh)(u,c,p.x),g=(0,O.jh)(h,d,p.x),f=(0,O.jh)(m,g,p.y);if(!s)return f;const y=new O.Zb(u.a,c.a,h.a,d.a),x=y.xy.multiply(y.zw),b=(0,O.RI)(x.x.multiply(x.y).add(.5)),w=f.multiply(b),C=(0,Z.zb)(b).multiply((0,O.US)(e,t));return w.add(C)}(t.texture,e,t.srcImageSize,n):(0,O.US)(t.texture,e)}(0,s.Cg)([(0,D.Pi)(O.z7)],Ce.prototype,"transformTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.ZY)],Ce.prototype,"targetImageSize",void 0),(0,s.Cg)([(0,D.Pi)(O.ZY)],Ce.prototype,"transformSpacing",void 0),(0,s.Cg)([(0,D.Pi)(O.ZY)],Ce.prototype,"transformGridSize",void 0);class Pe extends D.ZA{}(0,s.Cg)([(0,D.C5)(0,O.ZY)],Pe.prototype,"position",void 0);class Se extends D.HS{}class Re extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.z7)],Re.prototype,"texture",void 0),(0,s.Cg)([(0,D.Pi)(O.U)],Re.prototype,"dvsMat3",void 0),(0,s.Cg)([(0,D.Pi)(O.ZY)],Re.prototype,"coordScale",void 0),(0,s.Cg)([(0,D.Pi)(O.ZY)],Re.prototype,"srcImageSize",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],Re.prototype,"opacity",void 0);class Me extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.z7)],Me.prototype,"maskTexture",void 0);class ze extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.z7)],ze.prototype,"highlightTexture",void 0);class ke extends D.A{constructor(){super(...arguments),this.applyProjection=!0,this.lookupProjection=!1,this.bilinear=!1,this.bicubic=!1,this.nearestOnEdge=!1,this.applyPixelMask=!1,this.applyPixelHighlights=!1}vertex(e){const t=e.position,{dvsMat3:i,coordScale:s}=this.config,r=i.multiply(new O.eB(t.multiply(s),1));return{uv:t,glPosition:new O.Zb(r,1)}}fragment(e){const t=new D.mm,i=ve(e.uv,this.applyProjection?this.projectionConfig:void 0,this.lookupProjection);let s=this._colorize(i,e.uv);this.applyPixelHighlights&&(s=this._highlightPixels(e.uv,s));const r=(0,O.Tk)(function(e){const t=(0,O.PM)(new O.ZY(-1e-5,-1e-5),e).multiply((0,O.PM)(e,new O.ZY(1.00001,1.00001))),i=(0,Z.zb)(t.x.multiply(t.y));return new O.x(i)}(i),new O.Zb(0),s);let n=r.a.multiply(this.config.opacity);if(this.applyPixelMask){const t=this._getPixelMask(e.uv);n=n.multiply(t)}return t.fragColor=new O.Zb(r.rgb,1).multiply(n),t}_getPixel(e){const{config:t,bicubic:i,bilinear:s,nearestOnEdge:r}=this;return Te(e,t,{bicubic:i,bilinear:s,nearestOnEdge:r})}_getPixelMask(e){const{maskTexture:t}=this.pixelMaskConfig,i=(0,O.US)(t,e);return(0,O._S)(i.a)}_highlightPixels(e,t){const{highlightTexture:i}=this.highlightConfig,s=(0,O.US)(i,e),r=(0,O._S)(s.a);return(0,O.jh)(t,s,r)}}(0,s.Cg)([D.E8],ke.prototype,"applyProjection",void 0),(0,s.Cg)([D.E8],ke.prototype,"lookupProjection",void 0),(0,s.Cg)([D.E8],ke.prototype,"bilinear",void 0),(0,s.Cg)([D.E8],ke.prototype,"bicubic",void 0),(0,s.Cg)([D.E8],ke.prototype,"nearestOnEdge",void 0),(0,s.Cg)([D.E8],ke.prototype,"applyPixelMask",void 0),(0,s.Cg)([D.E8],ke.prototype,"applyPixelHighlights",void 0),(0,s.Cg)([(0,D.Pi)(Re)],ke.prototype,"config",void 0),(0,s.Cg)([(0,D.uK)(Ce)],ke.prototype,"projectionConfig",void 0),(0,s.Cg)([(0,D.uK)(Me)],ke.prototype,"pixelMaskConfig",void 0),(0,s.Cg)([(0,D.uK)(ze)],ke.prototype,"highlightConfig",void 0),(0,s.Cg)([(0,s.Qj)(0,(0,D.hF)(Pe))],ke.prototype,"vertex",null),(0,s.Cg)([(0,s.Qj)(0,(0,D.hF)(Se))],ke.prototype,"fragment",null);class Fe extends D.k2{}function Ie(e,t,i){let s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const{colormapTexture:r,colormapOffset:n,colormapMaxIndex:o}=i,a=e.r.multiply(t).subtract(n),l=(0,O.qE)(a,new O.nt(0),o),u=new O.ZY(l.add(.5).divide(o.add(1)),0),c=(0,O.US)(r,u),h=new O.Zb(c.rgb,c.a.multiply(e.a));if(s)return h;const d=(0,O.PM)(new O.nt(0),a).multiply((0,O.PM)(a,i.colormapMaxIndex));return h.multiply(d)}(0,s.Cg)([(0,D.Pi)(O.z7)],Fe.prototype,"colormapTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],Fe.prototype,"colormapOffset",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],Fe.prototype,"colormapMaxIndex",void 0);class Be extends ke{constructor(){super(...arguments),this.type="RasterColorizerLUTShader"}_colorize(e){return Ie(this._getPixel(e),new O.nt(1),this.colormapConfig,!1)}}function Ae(e){const t=new O.Zb(0,-1/3,2/3,-1),i=(0,O.Tk)((0,O.Xe)(e.y,e.z),new O.Zb(e.zy,t.wz),new O.Zb(e.yz,t.xy)),s=(0,O.Tk)((0,O.Xe)(e.x,i.x),new O.Zb(i.xyw,e.x),new O.Zb(e.x,i.yzx)),r=s.x.subtract((0,O.jk)(s.w,s.y)),n=new O.nt(1e-10),o=s.w.subtract(s.y),a=r.multiply(6).add(n),l=(0,O.tn)(o.divide(a).add(s.z)),u=s.x.add(n),c=(0,O.jk)(r.divide(u),new O.nt(1));return new O.eB(l,c,s.x)}function De(e){const t=new O.Zb(1,2/3,1/3,3),i=(0,O.tn)((0,O.jc)(e.xxx.add(t.xyz)).multiply(6).subtract(t.www)),s=(0,O.qE)(i.subtract(t.xxx),new O.eB(0,0,0),new O.eB(1));return e.z.multiply((0,O.jh)(t.xxx,s,e.y))}(0,s.Cg)([(0,D.Pi)(Fe)],Be.prototype,"colormapConfig",void 0);class Oe extends D.k2{}function Ze(e){const t=(0,O.tn)(e),i=(0,O.PM)(t,new O.ZY(1,1)).multiply(t),s=new O.nt(2).subtract(t),r=(0,O.PM)(new O.nt(1),t).multiply(s);return i.add(r)}function Ve(e,t,i){const s=new O.nt(1).divide(i),r=(0,O.US)(e,Ze(s.multiply(new O.ZY(-1,-1)).add(t))),n=(0,O.US)(e,Ze(s.multiply(new O.ZY(0,-1)).add(t))),o=(0,O.US)(e,Ze(s.multiply(new O.ZY(1,-1)).add(t))),a=(0,O.US)(e,Ze(s.multiply(new O.ZY(-1,0)).add(t))),l=(0,O.US)(e,Ze(t)),u=(0,O.US)(e,Ze(s.multiply(new O.ZY(1,0)).add(t))),c=(0,O.US)(e,Ze(s.multiply(new O.ZY(-1,1)).add(t))),h=(0,O.US)(e,Ze(s.multiply(new O.ZY(0,1)).add(t))),d=(0,O.US)(e,Ze(s.multiply(new O.ZY(1,1)).add(t))),p=new O.Zb(r.a,n.a,o.a,a.a),m=new O.Zb(u.a,c.a,h.a,d.a),g=p.multiply(m),f=g.xy.multiply(g.zw),y=f.x.multiply(f.y).multiply(l.a),x=new O.My(new O.nt(0),10);return x[0]=r.r,x[1]=n.r,x[2]=o.r,x[3]=a.r,x[4]=l.r,x[5]=u.r,x[6]=c.r,x[7]=h.r,x[8]=d.r,x[9]=y,x}function qe(e,t){const i=new O.Zb(e[5],e[3],e[7],e[1]).multiply(2),s=new O.eB(e[2],i[0],e[8]),r=new O.eB(e[0],i[1],e[6]),n=(0,O.Om)(s.subtract(r),new O.eB(1)),o=new O.eB(e[6],i[2],e[8]),a=new O.eB(e[0],i[3],e[2]),l=(0,O.Om)(o.subtract(a),new O.eB(1));return new O.ZY(n,l).multiply(t)}function Ue(e,t,i){const{factor:s}=t,r=qe(e,s),n=(0,O.RZ)((0,O.Om)(r,r).add(1)),o=e[9],{sinZsinAs:a,sinZcosAs:l,cosZs:u,weights:c}=t;if(!i){const e=Ee({sinZsinA:a[0],sinZcosA:l[0],cosZ:u[0],weights:new O.nt(1),dzxy:r,dzd:n});return new O.Zb(e,e,e,o)}const h=Ee({sinZsinA:new O.eB(a[0],a[1],a[2]),sinZcosA:new O.eB(l[0],l[1],l[2]),cosZ:new O.eB(u[0],u[1],u[2]),weights:new O.eB(c[0],c[1],c[2]),dzxy:r,dzd:n}),d=Ee({sinZsinA:new O.eB(a[3],a[4],a[5]),sinZcosA:new O.eB(l[3],l[5],l[5]),cosZ:new O.eB(u[3],u[4],u[5]),weights:new O.eB(c[3],c[4],c[5]),dzxy:r,dzd:n}),p=(0,O.Om)(h.add(d),new O.eB(1));return new O.Zb(p,p,p,o)}function Ee(e){const t=e.sinZsinA.multiply(e.dzxy.y),i=e.sinZcosA.multiply(e.dzxy.x),s=t.subtract(i),r=e.cosZ.add(s).divide(e.dzd);return r.multiply((0,O.PM)(new O.nt(0),r)).multiply(e.weights)}function je(e,t){const{pixelSizeFactor:i}=e,s=[e.factor[0]/t[0],e.factor[1]/t[1]];if(i>0){const{zFactor:r,pixelSizePower:n,gcsFactor:o}=e,a=t[0]*o,l=t[1]*o;s[0]=(r+a**n*i)/(8*a),s[1]=(r+l**n*i)/(8*l)}return s}(0,s.Cg)([(0,D.Pi)(O.My.ofType(O.nt,6))],Oe.prototype,"sinZcosAs",void 0),(0,s.Cg)([(0,D.Pi)(O.My.ofType(O.nt,6))],Oe.prototype,"sinZsinAs",void 0),(0,s.Cg)([(0,D.Pi)(O.My.ofType(O.nt,6))],Oe.prototype,"cosZs",void 0),(0,s.Cg)([(0,D.Pi)(O.My.ofType(O.nt,6))],Oe.prototype,"weights",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],Oe.prototype,"minValue",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],Oe.prototype,"maxValue",void 0),(0,s.Cg)([(0,D.Pi)(O.ZY)],Oe.prototype,"factor",void 0);class Ge extends ke{constructor(){super(...arguments),this.type="RasterColorizerShadedReliefShader",this.applyColormap=!1,this.isMultidirectional=!1}_colorize(e){const{texture:t}=this.config,i=Ue(Ve(t,e,this.config.srcImageSize),this.hillshadeConfig,this.isMultidirectional);if(!this.applyColormap)return new O.Zb(i.x,i.x,i.x,i.a);const{minValue:s,maxValue:r}=this.hillshadeConfig,n=this._getPixel(e),o=r.subtract(s),a=n.r.subtract(s),l=(0,O.qE)(a.divide(o),new O.nt(0),new O.nt(1)),u=Ie(new O.Zb(l,l,l,1),new O.nt(255),this.colormapConfig),c=Ae(u.xyz),h=De(new O.eB(c.xy,i.x));return new O.Zb(h,u.a.multiply(i.a))}}function Le(e){const t=(0,O._S)(e),i=e.add((0,O.tn)(t).subtract(1));return t.multiply(t).divide(i)}function He(e){return new O.Zb((0,O.RI)(e.rgb.add(.5)),e.a)}function We(e,t){return(0,O.PM)(t.x,e).multiply((0,O.PM)(e,t.y))}(0,s.Cg)([D.E8],Ge.prototype,"applyColormap",void 0),(0,s.Cg)([D.E8],Ge.prototype,"isMultidirectional",void 0),(0,s.Cg)([(0,D.Pi)(Oe)],Ge.prototype,"hillshadeConfig",void 0),(0,s.Cg)([(0,D.uK)(Fe)],Ge.prototype,"colormapConfig",void 0);class Ye extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.nt)],Ye.prototype,"minOutput",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],Ye.prototype,"maxOutput",void 0),(0,s.Cg)([(0,D.Pi)(O.eB)],Ye.prototype,"minCutOff",void 0),(0,s.Cg)([(0,D.Pi)(O.eB)],Ye.prototype,"maxCutOff",void 0),(0,s.Cg)([(0,D.Pi)(O.eB)],Ye.prototype,"factor",void 0),(0,s.Cg)([(0,D.Pi)(O.eB)],Ye.prototype,"gamma",void 0),(0,s.Cg)([(0,D.Pi)(O.eB)],Ye.prototype,"gammaCorrection",void 0);class Ne extends D.k2{}function Qe(e,t){const{minCutOff:i,maxCutOff:s,factor:r,minOutput:n}=t;return(0,O.qE)(e,i,s).subtract(i).multiply(r).add(n)}function $e(e,t){const{minCutOff:i,maxCutOff:s,minOutput:r,maxOutput:n,gamma:o,gammaCorrection:a}=t,l=(0,O.qE)(e,i,s).subtract(i),u=s.subtract(i),c=l.divide(u),h=(0,O.PM)(new O.nt(1),o),d=(0,O._S)(o.subtract(1)),p=n.subtract(r),m=new O.eB(1),g=(0,O.n7)(m.divide(p),c.multiply(a)),f=(0,Z.zb)(h.multiply(d).multiply(g)),y=(0,O.n7)(c,m.divide(o)),x=f.multiply(p).multiply(y).add(r);return(0,O.qE)(x,r,n)}function Ke(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:255;const r=i?$e(e.rgb,t).divide(s):Qe(e.rgb,t);return new O.Zb(r,e.a)}(0,s.Cg)([(0,D.Pi)(O.z7)],Ne.prototype,"minTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],Ne.prototype,"maxTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],Ne.prototype,"meanTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],Ne.prototype,"stddevTexture",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],Ne.prototype,"numberOfStandardDeviations",void 0);class Xe extends ke{constructor(){super(...arguments),this.type="RasterColorizerStretchShader",this.isMultiband=!0,this.applyColormap=!1,this.useGamma=!1,this.noOp=!1,this.draStretchType=0}_colorize(e){const t=this._getPixel(e);if(this.noOp)return t;const{draStretchType:i,stretchConfig:s,useGamma:r,statisticsConfig:n}=this;let o=0===i?Ke(t,s,r):function(e,t,i,s,r){const n=new O.Cq(0,0),o=new O.Ai(0);let a=(0,O.nP)(i.minTexture,n,o).rgb,l=(0,O.nP)(i.maxTexture,n,o).rgb;if(r){const e=(0,O.nP)(i.meanTexture,n,o).rgb,t=(0,O.nP)(i.stddevTexture,n,o).rgb.multiply(i.numberOfStandardDeviations);a=(0,O.T9)(a,e.subtract(t)),l=(0,O.jk)(l,e.add(t))}const u=l.subtract(a),c=new O.eB(Le(u.x),Le(u.y),Le(u.z)),h=t.maxOutput.subtract(t.minOutput).multiply(c),d={...t,minCutOff:a,maxCutOff:l,factor:h},p=s?$e(e.rgb,d).divide(255):Qe(e.rgb,d);return new O.Zb(p,e.a)}(t,s,n,r,2===i);if(this.isMultiband)return o;if(o=new O.Zb(o.rrr,o.a),this.applyColormap){const e=this.useGamma?255:1;o=Ie(o,new O.nt(e),this.colormapConfig)}return o}}(0,s.Cg)([D.E8],Xe.prototype,"isMultiband",void 0),(0,s.Cg)([D.E8],Xe.prototype,"applyColormap",void 0),(0,s.Cg)([D.E8],Xe.prototype,"useGamma",void 0),(0,s.Cg)([D.E8],Xe.prototype,"noOp",void 0),(0,s.Cg)([D.E8],Xe.prototype,"draStretchType",void 0),(0,s.Cg)([(0,D.Pi)(Ye)],Xe.prototype,"stretchConfig",void 0),(0,s.Cg)([(0,D.uK)(Fe)],Xe.prototype,"colormapConfig",void 0),(0,s.Cg)([(0,D.uK)(Ne)],Xe.prototype,"statisticsConfig",void 0);class Je extends B.j{constructor(){super(...arguments),this.name="BrushRasterColorizer",this.type=0,this.shaders={lut:new Be,stretch:new Xe,shadedRelief:new Ge},this._mosaicFbo=null,this._statisticsTechnique=null}shutdown(e){super.shutdown(e),this._mosaicFbo=(0,v.WD)(this._mosaicFbo),this._statisticsTechnique=(0,v.WD)(this._statisticsTechnique)}render(e,t){const i=t.bitmaps.some(et);i||(this._mosaicFbo=(0,v.WD)(this._mosaicFbo),this._statisticsTechnique=(0,v.WD)(this._statisticsTechnique));const s=i?this._computeStatisticsTextures(e,t):void 0;for(const r of t.bitmaps){if(!r.source||r.suspended)continue;e.timeline.begin(this.name);const{painter:t}=e;t.setPipelineState({depth:!1,stencil:{test:{mask:255,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:"composite"}}),r.updateTexture(e),r.updateProcessedTexture();const{type:i}=r.symbolizerParameters,n="stretch"===i?this._getStretchOptions(r,s):"lut"===i?this._getLutOptions(r):this._getShadedReliefOptions(r);"bilinear"!==r.interpolation||e.context.capabilities.textureFloatLinear||(n.defines.bilinear=!0),t.submitDrawMesh(e.context,n,t.quadMesh,r),e.timeline.end(this.name)}}_computeStatisticsTextures(e,t){this._statisticsTechnique??=new he;const i=this._statisticsTechnique;return this._mosaic(e,t),i.render(e,{fbo:this._mosaicFbo}),{minTexture:i.minValuesTexture,maxTexture:i.maxValuesTexture,meanTexture:i.meanValuesTexture,stddevTexture:i.stdDevValuesTexture}}_mosaic(e,t){const{context:i,painter:s}=e,r=i.getBoundFramebufferObject();if(this._mosaicFbo)this._mosaicFbo.resize(r.width,r.height);else{const e=function(e,t,i){const s=new ue.R(t,i);return s.internalFormat=oe.H0.RGBA32F,s.samplingMode=9728,s.dataType=oe.ld.FLOAT,s.wrapMode=33071,new le.g(e,s)}(i,r.width,r.height);this._mosaicFbo=new ae.H(i,e)}i.bindFramebuffer(this._mosaicFbo);const n="RasterColorizerMosaic";for(const o of t.bitmaps){if(!et(o))continue;e.timeline.begin(n),s.setPipelineState({depth:!1,stencil:{test:{mask:255,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:"composite"}});const t=o.interpolation;o.interpolation="nearest",o.updateTexture(e),o.updateProcessedTexture();const i=this._getStretchOptions(o);i.defines.noOp=!0,s.submitDrawMesh(e.context,i,s.quadMesh,o),o.interpolation=t,e.timeline.end(n)}i.bindFramebuffer(r)}_getLutOptions(e){const{config:t,projectionConfig:i,colormapConfig:s,pixelMaskConfig:r,highlightConfig:n,projectionDefines:o}=this._getCommonConfig(e),a=be(e);return{shader:this.shaders.lut,uniforms:{projectionConfig:i,config:t,colormapConfig:s,pixelMaskConfig:r,highlightConfig:n},defines:{...o,...a,applyPixelMask:!!r,applyPixelHighlights:!!n},optionalAttributes:null,useComputeBuffer:!1}}_getStretchOptions(e,t){const i=e.symbolizerParameters,{config:s,projectionConfig:r,colormapConfig:n,pixelMaskConfig:o,highlightConfig:a,projectionDefines:l,textureUnit:u}=this._getCommonConfig(e),c=be(e),h=t?{minTexture:{texture:t.minTexture,unit:u},maxTexture:{texture:t.maxTexture,unit:u+1},meanTexture:{texture:t.meanTexture,unit:u+2},stddevTexture:{texture:t.stddevTexture,unit:u+3},numberOfStandardDeviations:i.numberOfStandardDeviations||2}:void 0,d=t?"standardDeviation"===i.stretchType?2:1:0;return{shader:this.shaders.stretch,uniforms:{projectionConfig:r,config:s,stretchConfig:i,colormapConfig:n,pixelMaskConfig:o,highlightConfig:a,statisticsConfig:h},defines:{...l,...c,isMultiband:i.bandCount>1,applyColormap:!!n,useGamma:i.useGamma,noOp:e.isRendereredSource&&!e.processed,applyPixelMask:!!o,applyPixelHighlights:!!a,draStretchType:d},optionalAttributes:null,useComputeBuffer:!1}}_getShadedReliefOptions(e){const t=e.symbolizerParameters,{config:i,projectionConfig:s,colormapConfig:r,pixelMaskConfig:n,highlightConfig:o,projectionDefines:a}=this._getCommonConfig(e),l=be(e);return{shader:this.shaders.shadedRelief,uniforms:{projectionConfig:s,config:i,hillshadeConfig:t,colormapConfig:r,pixelMaskConfig:n,highlightConfig:o},defines:{...a,...l,isMultidirectional:t.hillshadeType>0,applyColormap:!!r,applyPixelMask:!!n,applyPixelHighlights:!!o},optionalAttributes:null,useComputeBuffer:!1}}_getCommonConfig(e){const{coordScale:t,computedOpacity:i,transforms:s}=e,{names:r,textures:n}=e.getTextures({useProcessedTexture:e.processed}),o=n[r.indexOf("u_image")],a=e.getRasterTextureSize();let l=0;const u={texture:{texture:o,unit:l++},dvsMat3:s.displayViewScreenMat3,coordScale:t,srcImageSize:a,opacity:i},c=n[r.indexOf("u_transformGrid")],{transformGrid:h}=e,d=!(!c||!h),p=d?{transformTexture:{texture:c,unit:l++},targetImageSize:[e.width,e.height],transformSpacing:h.spacing,transformGridSize:h.size}:void 0,m=n[r.indexOf("u_colormap")],{colormap:g,colormapOffset:f}=e.symbolizerParameters,y=m&&g?{colormapTexture:{texture:m,unit:l++},colormapOffset:f??0,colormapMaxIndex:g.length/4-1}:void 0,x=n[r.indexOf("u_mask")],b=x?{maskTexture:{texture:x,unit:l++}}:void 0,{highlightTexture:w}=e;return{config:u,projectionConfig:p,colormapConfig:y,pixelMaskConfig:b,highlightConfig:w?{highlightTexture:{texture:w,unit:l++}}:void 0,projectionDefines:{applyProjection:d,lookupProjection:d&&1===h.spacing[0]},textureUnit:l}}}function et(e){return!e.suspended&&null!=e.source&&!e.isRendereredSource&&"stretch"===e.symbolizerParameters.type&&!!e.symbolizerParameters.dynamicRangeAdjustment}var tt=i(5095);class it extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.My.ofType(O.nt,2*b.et))],it.prototype,"ranges",void 0),(0,s.Cg)([(0,D.Pi)(O.U)],it.prototype,"bandSwap",void 0),(0,s.Cg)([(0,D.Pi)(O.Zb)],it.prototype,"color",void 0);class st extends ke{constructor(){super(...arguments),this.type="RasterRangeHighlightShader",this.hasExistingHighlights=!1}_colorize(e,t){const i=this._getPixel(e),{ranges:s,color:r,bandSwap:n}=this.rangeHighlightConfig,o=function(e,t){let i=new O.eB(0,0,0);const s=new O.eB(e);for(let r=0;r<b.et/3;r++){const e=6*r,n=new O.eB(t[e],t[e+2],t[e+4]),o=new O.eB(t[e+1],t[e+3],t[e+5]);i=i.add((0,O.PM)(n,s).multiply((0,O.PM)(s,o)))}return(0,O._S)((0,O.Om)(i,new O.eB(1,1,1)))}(n.multiply(i.rgb).x,s).multiply((0,O._S)(i.a)),a=(0,O.jh)(new O.Zb(0),r,o);if(this.hasExistingHighlights){const{highlightTexture:e}=this.highlightConfig,i=(0,O.US)(e,t);return(0,O.jh)(i,a,o)}return a}}(0,s.Cg)([D.E8],st.prototype,"hasExistingHighlights",void 0),(0,s.Cg)([(0,D.Pi)(it)],st.prototype,"rangeHighlightConfig",void 0);class rt extends B.j{constructor(){super(...arguments),this.name="BrushRasterHighlight",this.type=2,this.shaders={range:new st}}shutdown(e){super.shutdown(e),this._fbo?.dispose(),this._fbo=void 0}render(e,t){const{context:i}=e;if(!this._fbo){const t=nt(e.context,tt.CQ,tt.CQ);this._fbo=new ae.H(i,t)}const s=i.getBoundFramebufferObject(),r=i.getViewport(),{pixelHighlightOptions:n}=e;for(const o of t.bitmaps){if(!n||!o.source||o.highlighted||o.suspended||o.isRendereredSource)continue;const t=o.bandIds?.length?o.bandIds.indexOf(n.bandId):0;if(t<0||t>2)continue;e.timeline.begin(this.name);const{painter:s}=e;s.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:"custom",blendParameters:{srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0}}}),o.updateTexture(e),o.updateProcessedTexture(!1);const{config:r,projectionConfig:a,highlightConfig:l,projectionDefines:u}=this._getCommonConfig(o),c=be(o);"bilinear"!==o.interpolation||e.context.capabilities.textureFloatLinear||(c.bilinear=!0);const h=new Float32Array(9);h[3*t]=1;const d={...n,bandSwap:h},p={shader:this.shaders.range,uniforms:{projectionConfig:a,config:r,rangeHighlightConfig:d,highlightConfig:l},defines:{...u,...c,applyPixelMask:!1,applyPixelHighlights:!1,hasExistingHighlights:!!l},optionalAttributes:null,useComputeBuffer:!1};i.bindFramebuffer(this._fbo),i.setViewport(0,0,tt.CQ,tt.CQ),s.submitDrawMesh(e.context,p,s.quadMesh);const m=nt(e.context,tt.CQ,tt.CQ);this._fbo.copyToTexture(0,0,tt.CQ,tt.CQ,0,0,m),o.highlightTexture=m,e.timeline.end(this.name)}i.bindFramebuffer(s),i.setViewport(r.x,r.y,r.width,r.height)}_getCommonConfig(e){const{names:t,textures:i}=e.getTextures({forProcessing:!0,useProcessedTexture:e.processed}),s=i[t.indexOf("u_image")],r=e.getRasterTextureSize(),n={texture:{texture:s,unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:r,opacity:1},o=i[t.indexOf("u_transformGrid")],{transformGrid:a}=e,l=!(!o||!a),u=l?{transformTexture:{texture:o,unit:1},targetImageSize:[e.width,e.height],transformSpacing:a.spacing,transformGridSize:a.size}:void 0,{highlightTexture:c}=e;return{config:n,projectionConfig:u,highlightConfig:c?{highlightTexture:{texture:c,unit:2}}:void 0,projectionDefines:{applyProjection:l,lookupProjection:l&&1===a.spacing[0]}}}}function nt(e,t,i){const s=new ue.R(t,i);return s.internalFormat=oe.H0.RGBA8,s.samplingMode=9728,s.dataType=oe.ld.UNSIGNED_BYTE,s.isImmutable=!0,s.wrapMode=33071,new le.g(e,s)}class ot extends B.j{shutdown(e){super.shutdown(e),this._fbo?.dispose(),this._fbo=void 0}render(e,t){const{rasterFunction:i}=e;if(!i)return;const{context:s}=e,r="indexedColormap"in i.parameters?(0,R.hE)(s,i.parameters.indexedColormap):void 0,n="Reproject"===i.name,o=s.getBoundFramebufferObject(),a=s.getViewport();for(const l of t.bitmaps){const o=n?!(l.rasterTexture&&l.projected):!l.processed;if(!l.source||!o||l.suspended)continue;e.timeline.begin(this.name);const{painter:a}=e;a.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:"custom",blendParameters:{srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0}}}),n||(l.processedTexture=(0,v.WD)(l.processedTexture)),l.updateTexture(e);const[u,c]=l.getRasterTextureSize(n),h=u===tt.CQ&&c===tt.CQ,d=h?t.processorFbo:xe(s,u,c);s.bindFramebuffer(d),s.setViewport(0,0,d.width,d.height),this._process(e,l,r);const p=ye(e.context,u,c);if(d.copyToTexture(0,0,u,c,0,0,p),n)l.rasterTexture=p;else{const t=e.hasBranches?i.id:0;l.functionTextures[t]?.dispose(),l.functionTextures[t]=p}h||d.dispose(),e.timeline.end(this.name)}r?.dispose(),s.bindFramebuffer(o),s.setViewport(a.x,a.y,a.width,a.height)}_getCommonConfig(e,t){const{rasterFunction:i,hasBranches:s}=e,{raster:r,rasters:n}=i.parameters,o=s?r?.id??n?.find(e=>"Constant"!==e.name)?.id??-1:0,a=t.functionTextures[o]??t.rasterTexture,l="Reproject"===i.name;return{texture:{texture:a,unit:0},srcImageSize:t.getRasterTextureSize(l)}}_getMultipleInputConfig(e,t){return t?.length?2===t.length?{twoRasterConfig:this._getTwoInputConfig(t,e)}:3===t.length?{threeRasterConfig:this._getThreeInputConfig(t,e)}:{}:{}}_getConstantCount(e){return e?.filter(e=>"Constant"===e.name).length??0}_getTextures(e,t){return e.filter(e=>"Constant"!==e.name).map(e=>null!=e.id&&"Identity"!==e.name?t.functionTextures[e.id]:t.rasterTexture)}_getTwoInputConfig(e,t){const i=this._getTextures(e,t),s=i[1]?{texture:i[1],unit:1}:void 0,r=e.findIndex(e=>"Constant"===e.name),n=0===r?new Float32Array([0,1,0,1,0,0,0,0,0]):new Float32Array([1,0,0,0,1,0,0,0,0]);return{image1:s,image1Const:r>-1?e[r].parameters.value:0,imageSwap:n}}_getThreeInputConfig(e,t){const i=this._getTextures(e,t);let s=0,r=0,n=new Float32Array([1,0,0,0,1,0,0,0,1]);const o=i[1]?{texture:i[1],unit:1}:void 0,a=i[2]?{texture:i[2],unit:2}:void 0,l=[];if(e.forEach((e,t)=>"Constant"===e.name&&l.push(t)),1===l.length)s=e[l[0]].parameters.value,n=0===l[0]?new Float32Array([0,1,0,0,0,1,1,0,0]):1===l[0]?new Float32Array([1,0,0,0,0,1,0,1,0]):new Float32Array([1,0,0,0,1,0,0,0,1]);else if(2===l.length){s=e[l[0]].parameters.value,r=e[l[1]].parameters.value;const t=e.findIndex(e=>"Constant"!==e.name);n=0===t?new Float32Array([1,0,0,0,1,0,0,0,1]):1===t?new Float32Array([0,1,0,1,0,0,0,0,1]):new Float32Array([0,0,1,1,0,0,0,1,0])}return{image1:o,image2:a,image1Const:s,image2Const:r,imageSwap:n}}}class at extends D.ZA{}(0,s.Cg)([(0,D.C5)(0,O.ZY)],at.prototype,"position",void 0);class lt extends D.HS{}class ut extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.z7)],ut.prototype,"texture",void 0),(0,s.Cg)([(0,D.Pi)(O.ZY)],ut.prototype,"srcImageSize",void 0);class ct extends D.A{vertex(e){return{uv:e.position,glPosition:new O.Zb((0,Z.nb)(e.position),0,1)}}fragment(e){const t=new D.mm,i=ve(e.uv),s=this._process(i);return t.fragColor=new O.Zb(s.rgb,1).multiply(s.a),t}_getPixel(e){return Te(e,this.config)}}(0,s.Cg)([(0,D.Pi)(ut)],ct.prototype,"config",void 0),(0,s.Cg)([(0,s.Qj)(0,(0,D.hF)(at))],ct.prototype,"vertex",null),(0,s.Cg)([(0,s.Qj)(0,(0,D.hF)(lt))],ct.prototype,"fragment",null);class ht extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.ZY)],ht.prototype,"cellSize",void 0);class dt extends ct{constructor(){super(...arguments),this.type="AspectShader"}_process(e){const{texture:t}=this.config,i=Ve(t,e,this.config.srcImageSize),s=new O.ZY(1).divide(this.aspectConfig.cellSize.multiply(8)),{x:r,y:n}=qe(i,s),o=(0,O.ze)(n),a=i[9].multiply((0,O._S)((0,O.tn)(r).add((0,O.tn)(o)))),l=(0,O.tn)((0,O._S)(r)),u=new O.nt(3.14159265359),c=new O.nt(0),h=(0,O.PM)(c,o).multiply(.5).multiply(u).add((0,O.PM)(o,c).multiply(1.5).multiply(u)),d=(0,O.zi)(new O.nt(2.5).multiply(u).add((0,O.rY)(o,(0,O.ze)(r))),new O.nt(2).multiply(u)),p=(0,O.jh)(h,d,l).multiply(180).divide(u);return new O.Zb(p,p,p,a)}}(0,s.Cg)([(0,D.Pi)(ht)],dt.prototype,"aspectConfig",void 0);class pt extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.U)],pt.prototype,"bandIndexMat3",void 0);class mt extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.eB)],mt.prototype,"adjustments",void 0);class gt extends ct{constructor(){super(...arguments),this.type="BandArithmeticShader",this.isOutputRounded=!1}_process(e){const t=this._getPixel(e),i=this.bandArithmeticConfig.bandIndexMat3.multiply(t.rgb),s=this._processIndex(i),r=new O.Zb(s,s,s,t.a);return this.isOutputRounded?He(r):r}_processIndex(e){const{r:t,g:i}=e,s=this.adjustmentConfig?.adjustments;switch(this.indexType){case"ndxi":{const e=t.subtract(i),s=t.add(i);return e.multiply(Le(s))}case"sr":return t.multiply(Le(i));case"ci":return t.multiply(Le(i)).subtract(1);case"savi":{const{x:e}=s,r=t.subtract(i),n=t.add(i).add(e);return r.multiply(Le(n)).multiply(e.add(1))}case"tsavi":{const{x:e,y:r,z:n}=s,o=n.multiply(e.multiply(e).add(1)).subtract(r.multiply(e)),a=e.multiply(t.subtract(e.multiply(i)).subtract(r)),l=r.multiply(t).add(i).add(o);return a.multiply(Le(l))}case"msavi":{const e=t.multiply(2).add(1),s=e.multiply(e).subtract(t.subtract(i).multiply(8));return e.subtract((0,O.RZ)(s)).multiply(.5)}case"gemi":{const e=t.multiply(t).subtract(i.multiply(i)).multiply(2).add(t.multiply(1.5)).add(i.multiply(.5)),s=t.add(i).add(.5),r=e.multiply(Le(s)),n=r.multiply((0,Z.zb)(r.multiply(.25))),o=i.subtract(.125).multiply(Le((0,Z.zb)(i)));return n.subtract(o)}case"pvi":{const{x:e,y:r}=s,n=(0,O.RZ)(e.multiply(e).add(1));return t.subtract(i.multiply(e)).subtract(r).multiply(Le(n))}case"vari":{const t=e.g.subtract(e.r),i=e.g.add(e.r).subtract(e.b);return t.multiply(Le(i))}case"rtvicore":return t.subtract(i).multiply(100).subtract(t.subtract(e.b).multiply(10));case"bai":{const e=(0,O.n7)(new O.nt(.1).subtract(i),new O.nt(2)),s=(0,O.n7)(new O.nt(.06).subtract(t),new O.nt(2));return Le(e.add(s))}case"evi":{const s=e.b,r=t.add(i.multiply(6)).subtract(s.multiply(7.5)).add(1);return t.subtract(i).multiply(2.5).multiply(Le(r))}case"wndwi":{const{r:t,g:i,b:r}=e,n=s.x,o=n.multiply(i),a=n.multiply(r),l=t.add(o).add(r).subtract(a);return t.subtract(o).subtract(r).add(a).multiply(Le(l))}case"mtvi":{const s=e.b,r=(0,O.n7)(t.multiply(2).add(1),new O.nt(2)),n=t.multiply(6).subtract((0,O.RZ)(i).multiply(5)),o=(0,O.RZ)(r.subtract(n).subtract(.5)),a=t.subtract(s).multiply(1.2),l=i.subtract(s).multiply(2.5);return a.subtract(l).multiply(1.5).multiply(Le(o))}default:return t}}}(0,s.Cg)([D.E8],gt.prototype,"indexType",void 0),(0,s.Cg)([D.E8],gt.prototype,"isOutputRounded",void 0),(0,s.Cg)([(0,D.Pi)(pt)],gt.prototype,"bandArithmeticConfig",void 0),(0,s.Cg)([(0,D.uK)(mt)],gt.prototype,"adjustmentConfig",void 0);class ft extends ct{constructor(){super(...arguments),this.type="ColormapToRGBShader"}_process(e){const t=Ie(this._getPixel(e),new O.nt(1),this.colormapConfig,!1);return new O.Zb(t.xyz.multiply(255),t.a)}}(0,s.Cg)([(0,D.Pi)(Fe)],ft.prototype,"colormapConfig",void 0);class yt extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.z7)],yt.prototype,"image1",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],yt.prototype,"image1Const",void 0),(0,s.Cg)([(0,D.Pi)(O.U)],yt.prototype,"imageSwap",void 0);class xt extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.z7)],xt.prototype,"image1",void 0),(0,s.Cg)([(0,D.Pi)(O.z7)],xt.prototype,"image2",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],xt.prototype,"image1Const",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],xt.prototype,"image2Const",void 0),(0,s.Cg)([(0,D.Pi)(O.U)],xt.prototype,"imageSwap",void 0);const bt=e=>{const t=e;class i extends t{constructor(){super(...arguments),this.constantCount=0,this.imageCount=1}_getRasterValues(e){const{imageCount:t}=this;if(1===t){const t=(0,O.US)(this.config.texture,e);return{a:t.r,b:t.g,c:t.b,alpha:t.a}}if(2===t){const t=this._getTwoValues(e);return{a:t.a,b:t.b,c:t.b,alpha:t.alpha}}return this._getThreeValues(e)}_getTwoValues(e){const t=(0,O.US)(this.config.texture,e);if(1===this.constantCount){const{imageSwap:e,image1Const:i}=this.twoRasterConfig,s=e.multiply(new O.eB(t.r,i,0));return{a:s.x,b:s.y,alpha:t.a}}const{image1:i}=this.twoRasterConfig,s=(0,O.US)(i,e);return{a:t.r,b:s.r,alpha:t.a.multiply(s.a)}}_getThreeValues(e){const t=(0,O.US)(this.config.texture,e),{imageSwap:i,image1:s,image2:r,image1Const:n,image2Const:o}=this.threeRasterConfig;if(2===this.constantCount){const e=i.multiply(new O.eB(t.r,n,o));return{a:e.x,b:e.y,c:e.z,alpha:t.a}}if(1===this.constantCount){const r=(0,O.US)(s,e),o=i.multiply(new O.eB(t.r,r.r,n));return{a:o.x,b:o.y,c:o.z,alpha:t.a.multiply(r.a)}}const a=(0,O.US)(s,e),l=(0,O.US)(r,e);return{a:t.r,b:a.r,c:l.r,alpha:t.a.multiply(a.a).multiply(l.a)}}}return(0,s.Cg)([D.E8],i.prototype,"constantCount",void 0),(0,s.Cg)([D.E8],i.prototype,"imageCount",void 0),(0,s.Cg)([(0,D.uK)(yt)],i.prototype,"twoRasterConfig",void 0),(0,s.Cg)([(0,D.uK)(xt)],i.prototype,"threeRasterConfig",void 0),i};class wt extends(bt(ct)){constructor(){super(...arguments),this.type="CompositeBandShader"}_process(e){const{a:t,b:i,c:s,alpha:r}=this._getRasterValues(e);return new O.Zb(t,i,s,r)}}class Ct extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.ZY)],Ct.prototype,"domainRange",void 0);class _t extends(bt(ct)){constructor(){super(...arguments),this.type="LocalShader",this.isOutputRounded=!1}_process(e){if("conditional"===this.operationName)return this._conditional(e);const{a:t,b:i,alpha:s}=this._getRasterValues(e),{value:r,alpha:n}=this._compute(t,i,s);return this._processResult(r,n)}_processResult(e,t){const i=We(e,this.domainRangeConfig.domainRange),s=new O.Zb(e,e,e,t).multiply(i);return this.isOutputRounded?He(s):s}_compute(e,t,i){const{operationName:s}=this;let r;switch(s){case"plus":r=e.add(t);break;case"minus":r=e.subtract(t);break;case"times":r=e.multiply(t);break;case"divide":case"floatdivide":r=e.multiply(Le(t)),i=i.multiply((0,O.fV)((0,O.tn)((0,O._S)(t))));break;case"floordivide":r=(0,O.RI)(e.multiply(Le(t))),i=i.multiply((0,O.fV)((0,O.tn)((0,O._S)(t))));break;case"square":r=e.multiply(e);break;case"sqrt":r=(0,O.RZ)(e);break;case"power":r=(0,O.n7)(e,t);break;case"ln":r=(0,O.Tk)((0,O.MM)(e,new O.nt(0)),(0,O.Rm)(e),new O.nt(0)),i=i.multiply(this._isAboveZero(e));break;case"log10":r=(0,O.Tk)((0,O.MM)(e,new O.nt(0)),(0,O.p6)(e).multiply(Le((0,O.p6)(new O.nt(10)))),new O.nt(0)),i=i.multiply(this._isAboveZero(e));break;case"log2":r=(0,O.Tk)((0,O.MM)(e,new O.nt(0)),(0,O.p6)(e),new O.nt(0)),i=i.multiply(this._isAboveZero(e));break;case"exp":r=(0,O.oN)(e);break;case"exp10":r=(0,O.n7)(new O.nt(10),e);break;case"exp2":r=(0,O.n7)(new O.nt(2),e);break;case"rounddown":r=(0,O.RI)(e);break;case"roundup":r=(0,O.mk)(e);break;case"int":r=(0,O._S)(e).multiply((0,O.RI)((0,O.tn)(e)));break;case"mod":r=(0,O.zi)(e,t);break;case"negate":r=(0,O.ze)(e);break;case"abs":r=(0,O.tn)(e);break;case"acos":{const t=this._isAbsBiggerThanOne(e);r=(0,O.Tk)(t,new O.nt(0),(0,O.HQ)(e)),i=(0,O.Tk)(t,new O.nt(0),i);break}case"acosh":r=(0,O.YN)(e);break;case"asin":{const t=this._isAbsBiggerThanOne(e);r=(0,O.Tk)(t,new O.nt(0),(0,O.qR)(e)),i=(0,O.Tk)(t,new O.nt(0),i);break}case"asinh":r=(0,O.yH)(e);break;case"atan":r=(0,O.rY)(e);break;case"atanh":{const t=this._isAbsBiggerThanOne(e);r=(0,O.Tk)(t,new O.nt(0),(0,O.rf)(e)),i=(0,O.Tk)(t,new O.nt(0),i);break}case"atan2":r=(0,O.rY)(e,t);break;case"cos":r=(0,O.gn)(e);break;case"cosh":r=(0,O.yI)(e);break;case"sin":r=(0,O.F8)(e);break;case"sinh":r=(0,O.L0)(e);break;case"tan":r=(0,O.Ml)(e);break;case"tanh":r=(0,O.ym)(e);break;case"bitwiseand":r=new O.nt((0,O.nf)(new O.Ai(e),new O.Ai(t)));break;case"bitwiseor":r=new O.nt((0,O.pu)(new O.Ai(e),new O.Ai(t)));break;case"bitwiseleftshift":r=new O.nt((0,O.wH)(new O.Ai(e),new O.Ai(t)));break;case"bitwiserightshift":r=new O.nt((0,O.Sj)(new O.Ai(e),new O.Ai(t)));break;case"bitwisenot":r=new O.nt((0,O.FM)(new O.Ai(e)));break;case"bitwisexor":r=new O.nt((0,O.hC)(new O.Ai(e),new O.Ai(t)));break;case"booleanand":r=(0,O.fV)((0,O.Uo)((0,O.Ec)(e,new O.nt(0)),(0,O.Ec)(t,new O.nt(0))));break;case"booleanor":r=(0,O.fV)((0,O.or)((0,O.Ec)(e,new O.nt(0)),(0,O.Ec)(t,new O.nt(0))));break;case"booleannot":r=(0,O.fV)((0,O.LC)(e,new O.nt(0)));break;case"booleanxor":r=(0,O.fV)((0,O.I8)((0,O.Ec)(e,new O.nt(0)),(0,O.Ec)(t,new O.nt(0))));break;case"greaterthan":r=(0,O.fV)((0,O.MM)(e,t));break;case"greaterthanequal":r=(0,O.fV)((0,O.aX)(e,t));break;case"lessthan":r=(0,O.fV)((0,O.Xe)(e,t));break;case"lessthanequal":r=(0,O.fV)((0,O.$5)(e,t));break;case"equalto":r=(0,O.fV)((0,O.LC)(e,t));break;case"notequal":r=(0,O.fV)((0,O.Ec)(e,t));break;case"isnull":r=(0,O.fV)((0,O.LC)(i,new O.nt(0))),i=new O.nt(1);break;case"setnull":{const s=(0,O.fV)((0,O.LC)(e,new O.nt(0)));r=s.multiply(t),i=i.multiply(s);break}default:r=e}return{value:r,alpha:i}}_conditional(e){const{a:t,b:i,c:s,alpha:r}=this._getRasterValues(e),n=new O.nt((0,O.tn)((0,O._S)(t))),o=(0,O.jh)(s,i,n);return this._processResult(o,r)}_isAboveZero(e){return(0,O.fV)((0,O.MM)(e,new O.nt(0)))}_isAbsBiggerThanOne(e){return(0,O.MM)((0,O.tn)(e),new O.nt(1))}}(0,s.Cg)([D.E8],_t.prototype,"operationName",void 0),(0,s.Cg)([D.E8],_t.prototype,"isOutputRounded",void 0),(0,s.Cg)([(0,D.Pi)(Ct)],_t.prototype,"domainRangeConfig",void 0);class vt extends(bt(ct)){constructor(){super(...arguments),this.type="ComputeChangeShader",this.isOutputRounded=!1}_process(e){const{a:t,b:i,alpha:s}=this._getRasterValues(e);let r=t.subtract(i);"relative-difference"===this.method&&(r=r.multiply(Le((0,O.T9)((0,O.tn)(t),(0,O.tn)(i)))));const n=We(r,this.domainRangeConfig.domainRange),o=new O.Zb(r,r,r,s).multiply(n);return this.isOutputRounded?He(o):o}}(0,s.Cg)([D.E8],vt.prototype,"method",void 0),(0,s.Cg)([D.E8],vt.prototype,"isOutputRounded",void 0),(0,s.Cg)([(0,D.Pi)(Ct)],vt.prototype,"domainRangeConfig",void 0);class Tt extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.nt)],Tt.prototype,"contrastOffset",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],Tt.prototype,"brightnessOffset",void 0);class Pt extends ct{constructor(){super(...arguments),this.type="ContrastBrightnessShader"}_process(e){const{rgb:t,a:i}=this._getPixel(e),{contrastOffset:s,brightnessOffset:r}=this.contrastBrightnessConfig,n=new O.nt(255),o=new O.nt(128),a=t.multiply(200),l=n.multiply(100),u=n.multiply(2).multiply(r),c=a.subtract(l).add(u),h=(0,O.j1)([(0,O.LC)(s,new O.nt(-100)),new O.eB(o)],[(0,O.LC)(s,new O.nt(100)),(0,O._S)(c).add(1).divide(2).multiply(n)],[(0,O.MM)(s,new O.nt(0)),c.divide(new O.nt(100).subtract(s).multiply(2)).add(o)],[!0,c.multiply(s.add(100)).divide(2e4).add(o)]);return He(new O.Zb(h,i))}}(0,s.Cg)([(0,D.Pi)(Tt)],Pt.prototype,"contrastBrightnessConfig",void 0);class St extends D.k2{}(0,s.Cg)([(0,D.Pi)(O._i.ofType(O.nt,5,5,!0))],St.prototype,"kernel",void 0),(0,s.Cg)([(0,D.Pi)(O.ZY)],St.prototype,"clampRange",void 0);class Rt extends ct{constructor(){super(...arguments),this.type="ConvolutionShader",this.rows=3,this.cols=3}_process(e){const{rows:t,cols:i}=this,s=new O.ZY(Math.floor(t/2),Math.floor(i/2)),{texture:r,srcImageSize:n}=this.config,o=new O.nt(1).divide(n),{kernel:a}=this.convolutionConfig,l=(0,O.$T)(a,{initialValue:new O.Zb(0,0,0,1),xRange:[0,t],yRange:[0,i],callback:(t,i,n,a)=>{const l=new O.ZY(new O.nt(n),new O.nt(a)).subtract(s).multiply(o),u=(0,O.US)(r,Ze(e.add(l))),c=u.rgb.multiply(i).add(t.rgb),h=u.a.multiply(t.a);return new O.Zb(c,h)}}),{clampRange:u}=this.convolutionConfig;return new O.Zb((0,O.qE)(l.rgb,u.x,u.y),1).multiply(l.a)}}(0,s.Cg)([D.E8],Rt.prototype,"rows",void 0),(0,s.Cg)([D.E8],Rt.prototype,"cols",void 0),(0,s.Cg)([(0,D.Pi)(St)],Rt.prototype,"convolutionConfig",void 0);class Mt extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.nt)],Mt.prototype,"zlFactor",void 0);class zt extends ct{constructor(){super(...arguments),this.type="CurvatureShader"}_process(e){const{texture:t}=this.config,i=Ve(t,e,this.config.srcImageSize),s=i[3].add(i[5]).multiply(.5).subtract(i[4]),r=i[1].add(i[7]).multiply(.5).subtract(i[4]),{zlFactor:n}=this.curvatureConfig,{curvatureType:o}=this;let a;if("standard"===o)a=(0,O.ze)(n).multiply(s.add(r));else{const e=i[2].subtract(i[0]).add(i[6]).subtract(i[8]).divide(4),t=i[5].subtract(i[3]).divide(2),l=i[1].subtract(i[7]).divide(2),u=t.multiply(t),c=l.multiply(l),h=t.multiply(l),d=n.divide(u.add(c));a="profile"===o?(0,O.Om)(new O.eB(s,r,e),new O.eB(u,c,h)).multiply(d):(0,O.Om)(new O.eB(s,r,(0,O.ze)(e)),new O.eB(c,u,h)).multiply((0,O.ze)(d))}return new O.Zb(a,a,a,i[9])}}(0,s.Cg)([D.E8],zt.prototype,"curvatureType",void 0),(0,s.Cg)([(0,D.Pi)(Mt)],zt.prototype,"curvatureConfig",void 0);class kt extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.U)],kt.prototype,"bandIndexMat3",void 0);class Ft extends ct{constructor(){super(...arguments),this.type="ExtractBandShader"}_process(e){const t=this._getPixel(e),i=this.extractBandConfig.bandIndexMat3.multiply(t.rgb);return new O.Zb(i,t.a)}}(0,s.Cg)([(0,D.Pi)(kt)],Ft.prototype,"extractBandConfig",void 0);class It extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.ZY)],It.prototype,"clampRange",void 0);class Bt extends ct{constructor(){super(...arguments),this.type="FocalStatisticsShader",this.rows=3,this.cols=3,this.fill=!1}_process(e){const t=this._process1(e),i=(0,O.PM)(new O.nt(1),t.a);if(!this.fill)return this._clamp(t.rgb,i);const s=this._getPixel(e),r=(0,O.jh)(t.rgb,s.rgb,s.a);return this._clamp(r,i)}_clamp(e,t){const{clampRange:i}=this.focalStatisticsConfig;return new O.Zb((0,O.qE)(e,i.x,i.y),1).multiply(t)}_process1(e){const{texture:t,srcImageSize:i}=this.config,{rows:s,cols:r}=this,n=new O.ZY(Math.floor(s/2),Math.floor(r/2)),o=new O.nt(1).divide(i),a=this._getPixel(e),{statisticsType:l}=this,u="min"===l||"max"===l?new O.Zb(a.rgb,0):new O.Zb(0,0,0,0);switch(l){case"min":return this._stat(s,r,u,(i,s,r)=>{const a=new O.ZY(new O.nt(s),new O.nt(r)).subtract(n).multiply(o),l=(0,O.US)(t,Ze(e.add(a))),u=(0,O.jk)(i.rgb,l.rgb);return new O.Zb(u,i.a.add(l.a))});case"max":return this._stat(s,r,u,(i,s,r)=>{const a=new O.ZY(new O.nt(s),new O.nt(r)).subtract(n).multiply(o),l=(0,O.US)(t,Ze(e.add(a))),u=(0,O.T9)(i.rgb,l.rgb);return new O.Zb(u,i.a.add(l.a))});case"mean":{const i=this._stat(s,r,u,(i,s,r)=>{const a=new O.ZY(new O.nt(s),new O.nt(r)).subtract(n).multiply(o),l=(0,O.US)(t,Ze(e.add(a))),u=i.rgb.add(l.rgb.multiply(l.a));return new O.Zb(u,i.a.add(l.a))}),a=i.rgb.multiply(Le(i.a));return new O.Zb(a,i.a)}case"stddev":{const i=this._stat(s,r,u,(i,s,r)=>{const a=new O.ZY(new O.nt(s),new O.nt(r)).subtract(n).multiply(o),l=(0,O.US)(t,Ze(e.add(a))),u=i.rgb.add(l.rgb.multiply(l.a));return new O.Zb(u,i.a.add(l.a))}),a=this._stat(s,r,u,(i,s,r)=>{const a=new O.ZY(new O.nt(s),new O.nt(r)).subtract(n).multiply(o),l=(0,O.US)(t,Ze(e.add(a))),u=i.rgb.add(l.a.multiply(l.rgb).multiply(l.rgb));return new O.Zb(u,i.a.add(l.a))}),l=Le(a.a),c=(0,O.RZ)(a.subtract(i.multiply(i).multiply(l)).multiply(l));return new O.Zb(c.rgb,i.a)}default:return a}}_stat(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;const r=new O.Ai(0).setMutable().setDebugName("StatColIterator"),n=new O.Ai(0).setMutable().setDebugName("StatRowIterator"),o=i.setMutable().setDebugName("StatAccumulator"),a=s(o,r,n).setDebugName("StatPredicate"),l=(0,O.om)({iterX:r,iterY:n,accumulator:o},O.Zb,a,i=>{let{out:s,iterX:r,iterY:n,accumulator:o,subgraph:a}=i;return`\n  for (${n} = 0; ${n} < ${e}; ${n}++) {\n    for (${r} = 0; ${r} < ${t}; ${r}++) {\n  \n    ${a.body}\n  \n    ${o} = ${a.varName};\n    }\n  }\n  ${s} = ${o};\n  `}).setDebugName("statBody");return l}}(0,s.Cg)([D.E8],Bt.prototype,"rows",void 0),(0,s.Cg)([D.E8],Bt.prototype,"cols",void 0),(0,s.Cg)([D.E8],Bt.prototype,"statisticsType",void 0),(0,s.Cg)([D.E8],Bt.prototype,"fill",void 0),(0,s.Cg)([(0,D.Pi)(It)],Bt.prototype,"focalStatisticsConfig",void 0);class At extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.eB)],At.prototype,"weights",void 0);class Dt extends ct{constructor(){super(...arguments),this.type="GrayscaleShader"}_process(e){const t=this._getPixel(e),{weights:i}=this.grayscaleConfig,s=(0,O.Om)(i,t.rgb);return new O.Zb(s,s,s,t.a)}}(0,s.Cg)([(0,D.Pi)(At)],Dt.prototype,"grayscaleConfig",void 0);class Ot extends ct{constructor(){super(...arguments),this.type="HillshadeShader",this.isMultidirectional=!1}_process(e){const{texture:t}=this.config,i=Ue(Ve(t,e,this.config.srcImageSize),this.hillshadeConfig,this.isMultidirectional);return new O.Zb(i.rgb.multiply(255),i.a)}}(0,s.Cg)([D.E8],Ot.prototype,"isMultidirectional",void 0),(0,s.Cg)([(0,D.Pi)(Oe)],Ot.prototype,"hillshadeConfig",void 0);class Zt extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.My.ofType(O.nt,6))],Zt.prototype,"includedRanges",void 0),(0,s.Cg)([(0,D.Pi)(O.My.ofType(O.nt,b.et))],Zt.prototype,"noDataValues",void 0);class Vt extends ct{constructor(){super(...arguments),this.type="MaskShader",this.isMultiband=!0}_process(e){const t=this._getPixel(e),i=this._computeNoDataFactor(t.r),s=this._computeRangeFactor(t.rgb);let r;if(this.isMultiband){const e=this._computeNoDataFactor(t.g),n=this._computeNoDataFactor(t.b),o=new O.eB(i,e,n).multiply(s);r=o.x.multiply(o.y).multiply(o.z)}else r=i.multiply(s.x);return t.multiply(r)}_computeNoDataFactor(e){const{noDataValues:t}=this.maskConfig;let i=new O.eB(1);for(let s=0;s<b.et/3;s++){const r=3*s,n=new O.eB(t[r+0],t[r+1],t[r+2]),o=(0,O.tn)((0,O._S)(n.subtract(e)));i=i.multiply(o)}return i.x.multiply(i.y).multiply(i.z)}_computeRangeFactor(e){const{includedRanges:t}=this.maskConfig,i=new O.eB(t[0],t[2],t[4]),s=new O.eB(t[1],t[3],t[5]);return(0,O.PM)(i,e).multiply((0,O.PM)(e,s))}}(0,s.Cg)([D.E8],Vt.prototype,"isMultiband",void 0),(0,s.Cg)([(0,D.Pi)(Zt)],Vt.prototype,"maskConfig",void 0);class qt extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.U)],qt.prototype,"bandIndexMat3",void 0);class Ut extends ct{constructor(){super(...arguments),this.type="NDVIShader",this.scaled=!0}_process(e){const t=this._getPixel(e),{r:i,g:s}=this.ndviConfig.bandIndexMat3.multiply(t.rgb),r=i.subtract(s),n=i.add(s),o=r.multiply(Le(n));if(!this.scaled)return new O.Zb(o,o,o,t.a);const a=(0,O.RI)(o.multiply(100).add(100.5));return new O.Zb(a,a,a,t.a)}}(0,s.Cg)([D.E8],Ut.prototype,"scaled",void 0),(0,s.Cg)([(0,D.Pi)(qt)],Ut.prototype,"ndviConfig",void 0);class Et extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.My.ofType(O.nt,3*b.et))],Et.prototype,"rangeMaps",void 0),(0,s.Cg)([(0,D.Pi)(O.My.ofType(O.nt,2*b.et))],Et.prototype,"noDataRanges",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],Et.prototype,"unmatchMask",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],Et.prototype,"replacementValue",void 0),(0,s.Cg)([(0,D.Pi)(O.ZY)],Et.prototype,"clampRange",void 0);class jt extends ct{constructor(){super(...arguments),this.type="RemapShader"}_process(e){const t=this._getPixel(e),{rangeMaps:i,unmatchMask:s,clampRange:r,replacementValue:n}=this.remapConfig,{mapValue:o,includeMask:a}=function(e,t,i){const s=new O.eB(e);let r=new O.eB(0,0,0),n=new O.nt(0);for(let o=0;o<i/3;o++){const e=9*o,i=new O.eB(t[e],t[e+3],t[e+6]),a=new O.eB(t[e+1],t[e+4],t[e+7]),l=(0,O.PM)(i,s).multiply((0,O.PM)(s,a)),u=new O.eB(t[e+2],t[e+5],t[e+8]);n=(0,O.jh)(n,u.x,l.x),n=(0,O.jh)(n,u.y,l.y),n=(0,O.jh)(n,u.z,l.z),r=r.add(l)}return{mapValue:n,includeMask:(0,O._S)((0,O.Om)(r,new O.eB(1,1,1)))}}(t.r,i,b.et),l=this.replaceUnmatched?n:s.multiply(t.r),u=(0,O.jh)(l,o,a),c=(0,O.qE)(u,r.x,r.y),h=this._computeNoDataFactor(t.rrr).multiply((0,O.T9)(s,a));return new O.Zb(c,c,c,t.a).multiply(h)}_computeNoDataFactor(e){const{noDataRanges:t}=this.remapConfig;let i=new O.eB(0,0,0);for(let s=0;s<b.et/3;s++){const r=6*s,n=new O.eB(t[r],t[r+2],t[r+4]),o=new O.eB(t[r+1],t[r+3],t[r+5]);i=i.add((0,O.PM)(n,e).multiply((0,O.PM)(e,o)))}return(0,Z.zb)((0,O._S)((0,O.Om)(i,new O.eB(1,1,1))))}}(0,s.Cg)([(0,D.Pi)(Et)],jt.prototype,"remapConfig",void 0),(0,s.Cg)([D.E8],jt.prototype,"replaceUnmatched",void 0);class Gt extends ke{constructor(){super(...arguments),this.type="ReprojectShader"}_colorize(e){return this._getPixel(e)}}class Lt extends Ot{constructor(){super(...arguments),this.type="ShadedReliefShader"}_process(e){const t=super._process(e),{minValue:i,maxValue:s}=this.hillshadeConfig,r=this._getPixel(e),n=s.subtract(i),o=r.r.subtract(i),a=(0,O.qE)(o.divide(n),new O.nt(0),new O.nt(1)),l=Ie(new O.Zb(a,a,a,1),new O.nt(255),this.colormapConfig),u=Ae(l.xyz),c=De(new O.eB(u.xy,t.x.divide(255))).multiply(255);return new O.Zb(c,l.a.multiply(t.a))}}(0,s.Cg)([(0,D.Pi)(Fe)],Lt.prototype,"colormapConfig",void 0);class Ht extends D.k2{}(0,s.Cg)([(0,D.Pi)(O.nt)],Ht.prototype,"pixelSizePower",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],Ht.prototype,"pixelSizeFactor",void 0),(0,s.Cg)([(0,D.Pi)(O.nt)],Ht.prototype,"zFactor",void 0),(0,s.Cg)([(0,D.Pi)(O.ZY)],Ht.prototype,"cellSize",void 0);class Wt extends ct{constructor(){super(...arguments),this.type="SlopeShader",this.isOutputRounded=!1,this.percentRise=!1}_process(e){const{cellSize:t,pixelSizePower:i,pixelSizeFactor:s,zFactor:r}=this.slopeConfig,n=(0,O.n7)(t,new O.ZY(i)).multiply(s).add(r).divide(t.multiply(8)),{texture:o}=this.config,a=Ve(o,e,this.config.srcImageSize),{x:l,y:u}=qe(a,n),c=(0,O.RZ)(l.multiply(l).add(u.multiply(u))),h=this.percentRise?c.multiply(100):(0,O.rY)(c).multiply(57.2957795),d=new O.Zb(h,h,h,a[9]);return this.isOutputRounded?He(d):d}}(0,s.Cg)([D.E8],Wt.prototype,"isOutputRounded",void 0),(0,s.Cg)([D.E8],Wt.prototype,"percentRise",void 0),(0,s.Cg)([(0,D.Pi)(Ht)],Wt.prototype,"slopeConfig",void 0);class Yt extends ct{constructor(){super(...arguments),this.type="StretchShader",this.isMultiband=!0,this.isOutputRounded=!1,this.useGamma=!1}_process(e){let t=Ke(this._getPixel(e),this.stretchConfig,this.useGamma,1);return this.isMultiband||(t=new O.Zb(t.rrr,t.a)),this.isOutputRounded?He(t):t}}(0,s.Cg)([D.E8],Yt.prototype,"isMultiband",void 0),(0,s.Cg)([D.E8],Yt.prototype,"isOutputRounded",void 0),(0,s.Cg)([D.E8],Yt.prototype,"useGamma",void 0),(0,s.Cg)([(0,D.Pi)(Ye)],Yt.prototype,"stretchConfig",void 0);const Nt=new Map([["Aspect",class extends ot{constructor(){super(...arguments),this.name="RasterAspectProcessor",this.type=3,this.shaders={aspect:new dt}}_process(e,t){const i={cellSize:t.getRasterCellSize()},s=this._getCommonConfig(e,t),r={shader:this.shaders.aspect,uniforms:{config:s,aspectConfig:i},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:o}=e;n.submitDrawMesh(o,r,n.quadMesh)}}],["BandArithmetic",class extends ot{constructor(){super(...arguments),this.name="RasterBandArithmeticProcessor",this.type=4,this.shaders={bandArithmetic:new gt}}_process(e,t){const i=e.rasterFunction.parameters,s={indexType:i.indexType,isOutputRounded:i.isOutputRounded},r={bandIndexMat3:i.bandIndexMat3},n=i.adjustments?{adjustments:[...i.adjustments]}:void 0,o=this._getCommonConfig(e,t),a={shader:this.shaders.bandArithmetic,uniforms:{config:o,bandArithmeticConfig:r,adjustmentConfig:n},defines:s,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,a,l.quadMesh)}}],["ColormapToRGB",class extends ot{constructor(){super(...arguments),this.name="RasterColormapToRGBProcessor",this.type=5,this.shaders={colormapToRGB:new ft}}_process(e,t,i){const s=e.rasterFunction.parameters,r={colormapTexture:{texture:i,unit:1},colormapOffset:s.offset,colormapMaxIndex:s.indexedColormap.length/4-1},n=this._getCommonConfig(e,t),o={shader:this.shaders.colormapToRGB,uniforms:{config:n,colormapConfig:r},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:l}=e;a.submitDrawMesh(l,o,a.quadMesh)}}],["CompositeBand",class extends ot{constructor(){super(...arguments),this.name="RasterCompositeBandProcessor",this.type=6,this.shaders={compositeBand:new wt}}_process(e,t){const{rasters:i}=e.rasterFunction.parameters,s={constantCount:this._getConstantCount(i),imageCount:i?.length??1},r=this._getMultipleInputConfig(t,i),n=this._getCommonConfig(e,t),o={shader:this.shaders.compositeBand,uniforms:{config:n,...r},defines:s,optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:l}=e;a.submitDrawMesh(l,o,a.quadMesh)}}],["ComputeChange",class extends ot{constructor(){super(...arguments),this.name="RasterComputeChangeProcessor",this.type=7,this.shaders={computeChange:new vt}}_process(e,t){const i=e.rasterFunction.parameters,{rasters:s}=i,r={constantCount:this._getConstantCount(s),imageCount:s.length,method:i.method,isOutputRounded:i.isOutputRounded},n={domainRange:i.domainRange},{twoRasterConfig:o}=this._getMultipleInputConfig(t,s),a=this._getCommonConfig(e,t),l={shader:this.shaders.computeChange,uniforms:{config:a,domainRangeConfig:n,twoRasterConfig:o},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:u,context:c}=e;u.submitDrawMesh(c,l,u.quadMesh)}}],["ContrastBrightness",class extends ot{constructor(){super(...arguments),this.name="RasterContrastBrightnessProcessor",this.type=8,this.shaders={contrastBrightness:new Pt}}_process(e,t){const i=this._getCommonConfig(e,t),s=e.rasterFunction.parameters,r={shader:this.shaders.contrastBrightness,uniforms:{config:i,contrastBrightnessConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:o}=e;n.submitDrawMesh(o,r,n.quadMesh)}}],["Convolution",class extends ot{constructor(){super(...arguments),this.name="RasterConvolutionProcessor",this.type=9,this.shaders={convolution:new Rt}}_process(e,t){const i=e.rasterFunction.parameters,s={rows:i.kernelRows,cols:i.kernelCols},r={kernel:[...i.kernel],clampRange:i.clampRange},n=this._getCommonConfig(e,t),o={shader:this.shaders.convolution,uniforms:{config:n,convolutionConfig:r},defines:s,optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:l}=e;a.submitDrawMesh(l,o,a.quadMesh)}}],["Curvature",class extends ot{constructor(){super(...arguments),this.name="RasterCurvatureProcessor",this.type=10,this.shaders={curvature:new zt}}_process(e,t){const i=e.rasterFunction.parameters,s={curvatureType:i.curvatureType},r=t.getRasterCellSize(),n={zlFactor:200*i.zFactor/r[0]/r[1]},o=this._getCommonConfig(e,t),a={shader:this.shaders.curvature,uniforms:{config:o,curvatureConfig:n},defines:s,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,a,l.quadMesh)}}],["ExtractBand",class extends ot{constructor(){super(...arguments),this.name="RasterExtractBandProcessor",this.type=11,this.shaders={extractBand:new Ft}}_process(e,t){const i={bandIndexMat3:e.rasterFunction.parameters.bandIndexMat3},s=this._getCommonConfig(e,t),r={shader:this.shaders.extractBand,uniforms:{config:s,extractBandConfig:i},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:o}=e;n.submitDrawMesh(o,r,n.quadMesh)}}],["Grayscale",class extends ot{constructor(){super(...arguments),this.name="RasterGrayscaleProcessor",this.type=12,this.shaders={grayscale:new Dt}}_process(e,t){const i={weights:e.rasterFunction.parameters.weights},s=this._getCommonConfig(e,t),r={shader:this.shaders.grayscale,uniforms:{config:s,grayscaleConfig:i},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:o}=e;n.submitDrawMesh(o,r,n.quadMesh)}}],["Hillshade",class extends ot{constructor(){super(...arguments),this.name="RasterHillshadeProcessor",this.type=13,this.shaders={hillshade:new Ot}}_process(e,t){const i=e.rasterFunction.parameters,s={isMultidirectional:i.hillshadeType>0},r=je(i,t.getRasterCellSize()),n={...i,factor:r,minValue:0,maxValue:8e3},o=this._getCommonConfig(e,t),a={shader:this.shaders.hillshade,uniforms:{config:o,hillshadeConfig:n},defines:s,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,a,l.quadMesh)}}],["Local",class extends ot{constructor(){super(...arguments),this.name="RasterLocalProcessor",this.type=14,this.shaders={local:new _t}}_process(e,t){const i=e.rasterFunction.parameters,s={constantCount:this._getConstantCount(i.rasters),imageCount:i.imageCount,operationName:i.operationName,isOutputRounded:i.isOutputRounded},r={domainRange:i.domainRange},n="conditional"===i.operationName?i.rasters:i.rasters?.slice(0,2),o=this._getMultipleInputConfig(t,n),a=this._getCommonConfig(e,t),l={shader:this.shaders.local,uniforms:{config:a,domainRangeConfig:r,...o},defines:s,optionalAttributes:null,useComputeBuffer:!1},{painter:u,context:c}=e;u.submitDrawMesh(c,l,u.quadMesh)}}],["Mask",class extends ot{constructor(){super(...arguments),this.name="RasterMaskProcessor",this.type=15,this.shaders={mask:new Vt}}_process(e,t){const i=e.rasterFunction.parameters,s={isMultiband:i.bandCount>1},r={includedRanges:[...i.includedRanges],noDataValues:[...i.noDataValues]},n=this._getCommonConfig(e,t),o={shader:this.shaders.mask,uniforms:{config:n,maskConfig:r},defines:s,optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:l}=e;a.submitDrawMesh(l,o,a.quadMesh)}}],["NDVI",class extends ot{constructor(){super(...arguments),this.name="RasterNDVIProcessor",this.type=16,this.shaders={ndvi:new Ut}}_process(e,t){const i=e.rasterFunction.parameters,s={scaled:i.scaled},r={bandIndexMat3:i.bandIndexMat3},n=this._getCommonConfig(e,t),o={shader:this.shaders.ndvi,uniforms:{config:n,ndviConfig:r},defines:s,optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:l}=e;a.submitDrawMesh(l,o,a.quadMesh)}}],["Remap",class extends ot{constructor(){super(...arguments),this.name="RasterRemapProcessor",this.type=17,this.shaders={remap:new jt}}_process(e,t){const i=e.rasterFunction.parameters,s={replaceUnmatched:i.allowUnmatched&&null!=i.replacementValue},r={rangeMaps:[...i.rangeMaps],noDataRanges:[...i.noDataRanges],unmatchMask:i.allowUnmatched?1:0,replacementValue:i.replacementValue??0,clampRange:i.clampRange},n=this._getCommonConfig(e,t),o={shader:this.shaders.remap,uniforms:{config:n,remapConfig:r},defines:s,optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:l}=e;a.submitDrawMesh(l,o,a.quadMesh)}}],["Reproject",class extends ot{constructor(){super(...arguments),this.name="RasterReprojectProcessor",this.type=18,this.shaders={reproject:new Gt}}_process(e,t){const i=e.rasterFunction.parameters,s=this._getInterpolationDefines(t.interpolation,!!i.requireNNEdge),{config:r,projectionConfig:n,projectionDefines:o}=this._getReprojectConfig(t),a={shader:this.shaders.reproject,uniforms:{config:r,projectionConfig:n},defines:{...o,...s,applyPixelMask:!1,applyPixelHighlights:!1},optionalAttributes:null,useComputeBuffer:!1},{interpolation:l}=t;t.interpolation="nearest";const{painter:u,context:c}=e;u.submitDrawMesh(c,a,u.quadMesh),t.interpolation=l,t.projected=!0}_getReprojectConfig(e){const{source:t}=e,{names:i,textures:s}=e.getTextures({forProcessing:!0}),r={texture:{texture:s[i.indexOf("u_image")],unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:[t.width,t.height],opacity:1},n=s[i.indexOf("u_transformGrid")],{transformGrid:o}=e,a=!(!n||!o);return{config:r,projectionConfig:a?{transformTexture:{texture:n,unit:1},targetImageSize:[e.width,e.height],transformSpacing:o.spacing,transformGridSize:o.size}:void 0,projectionDefines:{applyProjection:a,lookupProjection:a&&1===o.spacing[0]}}}_getInterpolationDefines(e,t){const i="bilinear"===e&&t;return{bilinear:i,bicubic:"cubic"===e,nearestOnEdge:i}}}],["ShadedRelief",class extends ot{constructor(){super(...arguments),this.name="RasterShadedReliefProcessor",this.type=19,this.shaders={shadedRelief:new Lt}}_process(e,t,i){const s=e.rasterFunction.parameters,r={isMultidirectional:s.hillshadeType>0},n=je(s,t.getRasterCellSize()),o={...s,factor:n},a={colormapTexture:{texture:i,unit:1},colormapOffset:s.offset,colormapMaxIndex:s.indexedColormap.length/4-1},l=this._getCommonConfig(e,t),u={shader:this.shaders.shadedRelief,uniforms:{config:l,hillshadeConfig:o,colormapConfig:a},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:h}=e;c.submitDrawMesh(h,u,c.quadMesh)}}],["Slope",class extends ot{constructor(){super(...arguments),this.name="RasterSlopeProcessor",this.type=20,this.shaders={slope:new Wt}}_process(e,t){const i=e.rasterFunction.parameters,s={isOutputRounded:i.isOutputRounded,percentRise:"percent-rise"===i.slopeType},r={cellSize:t.getRasterCellSize(),pixelSizePower:"adjusted"===i.slopeType?i.pixelSizePower:0,pixelSizeFactor:"adjusted"===i.slopeType?i.pixelSizeFactor:0,zFactor:i.zFactor},n=this._getCommonConfig(e,t),o={shader:this.shaders.slope,uniforms:{config:n,slopeConfig:r},defines:s,optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:l}=e;a.submitDrawMesh(l,o,a.quadMesh)}}],["Statistics",class extends ot{constructor(){super(...arguments),this.name="RasterFocalStatisticsProcessor",this.type=21,this.shaders={focalStatistics:new Bt}}_process(e,t){const i=e.rasterFunction.parameters,s={rows:i.kernelRows,cols:i.kernelCols,statisticsType:i.statisticsType,fill:i.fillNoDataOnly},r={clampRange:i.clampRange},n=this._getCommonConfig(e,t),o={shader:this.shaders.focalStatistics,uniforms:{config:n,focalStatisticsConfig:r},defines:s,optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:l}=e;a.submitDrawMesh(l,o,a.quadMesh)}}],["Stretch",class extends ot{constructor(){super(...arguments),this.name="RasterStretchProcessor",this.type=22,this.shaders={stretch:new Yt}}_process(e,t){const i=e.rasterFunction.parameters,s={isMultiband:i.bandCount>1,isOutputRounded:i.isOutputRounded,useGamma:i.useGamma},r=this._getCommonConfig(e,t),n={shader:this.shaders.stretch,uniforms:{config:r,stretchConfig:i},defines:s,optionalAttributes:null,useComputeBuffer:!1},{painter:o,context:a}=e;o.submitDrawMesh(a,n,o.quadMesh)}}]]);class Qt extends B.j{constructor(){super(...arguments),this.type=1,this.shaders={},this._techniques=new Map}shutdown(e){super.shutdown(e),this._fbo?.dispose(),this._fbo=void 0;for(const t of this._techniques.values())t.shutdown();this._techniques.clear()}render(e,t){this._fbo??=xe(e.context,tt.CQ,tt.CQ);let{name:i}=e.rasterFunction;if("Arithmetic"===i&&(i="Local"),!this._techniques.has(i)){const e=Nt.get(i);if(!e)return;this._techniques.set(i,new e)}this._techniques.get(i).render(e,{...t,processorFbo:this._fbo})}}class $t extends I.A{constructor(){super(...arguments),this.isCustomTilingScheme=!1}get pixelHighlights(){return this._pixelHighlights}set pixelHighlights(e){this._pixelHighlights=e,this.children.forEach(e=>{let{bitmap:t}=e;return t.highlightTexture=null}),this.requestRender()}createTile(e){const t=this._getTileBounds(e),[i,s]=this.tileInfoView.tileInfo.size,r=this.tileInfoView.getTileResolution(e.level);return new F(e,r,t[0],t[3],i,s)}onAttach(){super.onAttach(),this._colorizerTechnique=new Je,this._processorTechnique=new Qt,this._highlightTechnique=new rt}onDetach(){super.onDetach(),this._colorizerTechnique?.shutdown(),this._colorizerTechnique=void 0,this._processorTechnique?.shutdown(),this._processorTechnique=void 0,this._highlightTechnique?.shutdown(),this._highlightTechnique=void 0}doRender(e){if(!this.visible||1!==e.drawPhase||!this._colorizerTechnique)return;const{rasterFunctionChain:t}=this;if(t?.functions?.length){if(!this._processorTechnique)return;const{functions:i,hasBranches:s}=t;for(const t of i){if("Constant"===t.name||"Identity"===t.name)continue;e.rasterFunction=t,e.hasBranches=s,super.doRender(e);const i=this.children.map(e=>e.bitmap);this._processorTechnique.render(e,{bitmaps:i})}}if(this._pixelHighlights?.length&&this._highlightTechnique)for(const s of this._pixelHighlights){e.pixelHighlightOptions=s,super.doRender(e);const t=this.children.map(e=>e.bitmap);this._highlightTechnique.render(e,{bitmaps:t})}e.rasterFunction=null,e.pixelHighlightOptions=void 0,super.doRender(e);const i=this.children.map(e=>e.bitmap);this._colorizerTechnique.render(e,{bitmaps:i})}_getTileBounds(e){const t=this.tileInfoView.getTileBounds((0,w.vt)(),e);if(this.isCustomTilingScheme&&e.world){const{tileInfo:i}=this.tileInfoView,s=(0,C.FT)(i.spatialReference);if(s){const r=i.lodAt(e.level);if(!r)return t;const{resolution:n}=r,o=n*i.size[0];t[0]=s*e.world+i.origin.x+e.col*o,t[2]=t[0]+o}}return t}}var Kt=i(91967),Xt=i(19451),Jt=i(76797),ei=i(19247),ti=i(66486),ii=i(88235),si=i(12838),ri=i(59844),ni=i(40181),oi=(i(93453),i(15389)),ai=i(96345),li=i(59752);const ui=[0,0];let ci=class extends Kt.A{constructor(){var e;super(...arguments),e=this,this._updatingHandles=new Xt.U,this._emptyTilePixelBlock=null,this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=[],this.previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._isCustomTilingScheme=!1,this._maxIndexedColormapSize=0,this._rasterFunctionState="na",this._globalUpdateRequested=!1,this.attached=!1,this.timeExtent=null,this.redrawOrRefetch=(0,o.sg)(async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const i=e._rasterFunctionState,s=t.reprocess||"gpu"===i&&!e.canUseWebGLForProcessing||"cpu"===i&&e.canUseWebGLForProcessing;if(s&&(await e._updatingHandles.addPromise(e.layer.updateRasterFunction()),e.updateRasterFunctionParameters()),!e.previousLOD||e.layerView.suspended)return;const r=e._rasterFunctionState,{type:n}=e;return t.refetch||"raster"!==n&&s||"cpu"===r||"cpu"===i?e._updatingHandles.addPromise(e.doRefresh()):e._updatingHandles.addPromise(e._redrawImage(t.signal))})}destroy(){this._updatingHandles.destroy()}get canUseWebGLForProcessing(){return!1}get canUseLocalSymbolizerParams(){return(this.canUseWebGLForProcessing||"rasterVF"===this.type)&&!this.layerView.hasTilingEffects}get isCPUBasedDRA(){const{renderer:e}=this.layer;return"raster-stretch"===e?.type&&e.dynamicRangeAdjustment&&(!this.canUseWebGLForProcessing||!("min-max"===e.stretchType||"standard-deviation"===e.stretchType))}get useWebGLForProcessing(){return this._get("useWebGLForProcessing")??!0}set useWebGLForProcessing(e){this._set("useWebGLForProcessing",e)}get useProgressiveUpdate(){return this._get("useProgressiveUpdate")??!0}set useProgressiveUpdate(e){if(this._tileStrategy&&this.useProgressiveUpdate!==e){this._tileStrategy.destroy(),this.container.removeAllChildren();const t=this._getCacheSize(e);this._tileStrategy=new ai.A({cachePolicy:"purge",acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),cacheSize:t,tileInfoView:this._tileInfoView}),this._set("useProgressiveUpdate",e),this.layerView.requestUpdate()}}update(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume();const{extent:t,resolution:i,scale:s}=e.state,r=this._tileInfoView.getClosestInfoForScale(s);if(this.layer.raster){if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){const e=this._srcResolutions[r.level],s="toJSON"in t?t:Jt.A.fromJSON(t);(0,si.yo)(this._blockCacheRegistryUrl,this._blockCacheRegistryId,s,i,e,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,this.previousLOD?.level!==r.level&&(this.previousLOD=r,null!=this._symbolizerParams&&this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}}moveEnd(){!this.isCPUBasedDRA&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,0===this._fetchQueue.length&&this._redrawImage(this._abortController.signal).then(()=>{this._globalUpdateRequested=!1,this.layerView.requestUpdate()}));const e=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(e),this.layerView.requestUpdate()}get updating(){return this._globalUpdateRequested||this._updatingHandles?.updating}attach(){const e=(0,ne.C)();this._maxIndexedColormapSize=4*(e.maxTextureSize||4096),this._initializeTileInfo(),this._tileInfoView=new ni.A(this.layerView.tileInfo,this.layerView.fullExtent);const t=this._computeFetchConcurrency();this._fetchQueue=new oi.A({tileInfoView:this._tileInfoView,concurrency:t,process:(e,t)=>this._fetchTile(e,t),priority:li.W6.MAPVIEW_FETCH_QUEUE,scheduler:this.scheduler});const i=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new ai.A({cachePolicy:"purge",acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),cacheSize:i,tileInfoView:this._tileInfoView}),this._updateBlockCacheRegistry()}detach(){this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,(0,si.ht)(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryUrl=this._blockCacheRegistryId=null}acquireTile(e){const t=this.container.createTile(e);return this._updatingHandles.addPromise(this._enqueueTileFetch(t)),this.layerView.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.isCPUBasedDRA||!this.useProgressiveUpdate,t}releaseTile(e){this._fetchQueue.abort(e.key.id),this.container.removeChild(e),e.once("detach",()=>{e.destroy(),this.layerView.requestUpdate()}),this.layerView.requestUpdate()}createEmptyTilePixelBlock(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const t=null==e||e.join(",")===this._tileInfoView.tileInfo.size.join(",");if(t&&null!=this._emptyTilePixelBlock)return this._emptyTilePixelBlock;e=e||this._tileInfoView.tileInfo.size;const[i,s]=e,r=new ti.A({width:i,height:s,pixels:[new Uint8Array(i*s)],mask:new Uint8Array(i*s),pixelType:"u8"});return t&&(this._emptyTilePixelBlock=r),r}_getBandIds(){if(this.container&&(!("rasterFunctionChain"in this.container)||!this.container.rasterFunctionChain))return this.layer.bandIds;const{bandIds:e,raster:t}=this.layer,i="rasterFunction"in t?t.rasterFunction.rawInputBandIds:null;return e?.length&&i?.length&&1!==t.rasterInfo.bandCount?e.map(e=>i[Math.min(e,i.length-1)]):"rasterFunction"in t?i:e}updateRasterFunctionParameters(){}_fetchTile(e,t){const i=this._getFetchOptions(e.level,t.signal);return this.fetchTile(e,i)}_getFetchOptions(e,t){const{canUseWebGLForProcessing:i}=this,{layerView:s}=this,{tileInfo:r}=s,n=!r.isWrappable&&null!=(0,ri.FT)(s.view.spatialReference),o=i&&this.layer.raster.hasUniqueSourceStorageInfo,{layer:a}=this.layerView,l=a.serviceRasterInfo?.storageInfo.isBsqTile?a.getRawDisplayBandIds():void 0;return{allowPartialFill:!0,datumTransformation:s.datumTransformation,interpolation:i?"nearest":this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:o,skipRasterFunction:"raster"===this.type&&null!=this.container.rasterFunctionChain,signal:t,srcResolution:this._srcResolutions[e],timeExtent:s.timeExtent,tileInfo:r,bandIds:l,disableWrapAround:n}}_getCacheSize(e){return e?40:0}_initializeTileInfo(){const{layerView:e}=this,t=e.view.spatialReference;if(this._canUseLayerLODs()){const{origin:i,lods:s}=this.layer.tileInfo,r=s.map(e=>{let{scale:t}=e;return t}),n=ii.A.create({spatialReference:t,size:tt.CQ,scales:r,origin:i});return e.set("tileInfo",n),void(this._srcResolutions=s.map(e=>{let{resolution:t}=e;return{x:t,y:t}}))}const{scales:i,srcResolutions:s,isCustomTilingScheme:r}=(0,ri.dK)(this.layer.serviceRasterInfo,t,{tileSize:tt.CQ,alignGlobalDatasetWithAGOL:!0,limitToSrcResolution:!1}),n=ii.A.create({spatialReference:t,size:tt.CQ,scales:i}),o=0===n.origin.x;(0,v.Lw)(e.fullExtent);const{xmin:a,ymax:l}=e.fullExtent;(o||r&&n.origin.x>a)&&(n.origin=new ei.A({x:a,y:l,spatialReference:t})),this._isCustomTilingScheme=r,e.set("tileInfo",n),this._srcResolutions=s??[]}_canUseLayerLODs(){const{layer:e,layerView:t}=this;if("Map"!==e.raster.tileType)return!1;const{lods:i}=e.tileInfo,s=t.view.constraints?.effectiveLODs;return s?.length===i.length&&s.every((e,t)=>{let{scale:s}=e;return Math.abs(s-i[t].scale)<.001})}_computeFetchConcurrency(){const{blockBoundary:e}=this.layer.serviceRasterInfo.storageInfo,t=e[e.length-1];return(t.maxCol-t.minCol+1)*(t.maxRow-t.minRow+1)>64?2:10}async _enqueueTileFetch(e,t){if(!this._fetchQueue.has(e.key.id)){try{let t=e.once("detach",()=>t=void 0);const s=await this._fetchQueue.push(e.key),r=this._getBandIds();let a=!this.useProgressiveUpdate||this.isCPUBasedDRA&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.layerView.moving&&0===this._fetchQueue.length){a=!1;try{await this._redrawImage(this._abortController?.signal)}catch(i){(0,o.zf)(i)&&n.A.getLogger(this).error(i)}this._globalUpdateRequested=!1}if(!t)return;this.canUseLocalSymbolizerParams&&null==this._symbolizerParams&&this._updateSymbolizerParams();const l=this._tileInfoView.getTileCoords(ui,e.key),u=this._tileInfoView.getTileResolution(e.key);await this.updateTileSource(e,{source:s,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:a,bandIds:r,coords:l,resolution:u}),t&&(e.once("attach",()=>this.layerView.requestUpdate()),this.container.addChild(e),t.remove())}catch(i){(0,o.zf)(i)||n.A.getLogger(this).error(i)}this.layerView.requestUpdate()}}async _redrawImage(e){if(!this.attached||0===this.container.children.length)return;if(await this.layer.updateRenderer(),this.isCPUBasedDRA?await this._updateGlobalSymbolizerParams(e):(this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._globalSymbolizerParams=null),!this.attached||e?.aborted)return;const t=this.container.children.map(async t=>this.updateTileSymbolizerParameters(t,{local:this._symbolizerParams,global:this._globalSymbolizerParams},e));await Promise.allSettled(t),this.attached&&!e?.aborted&&this.container.requestRender()}async _updateGlobalSymbolizerParams(e){const t=this._getFetchOptions(this.previousLOD.level,e),i=await this.layer.fetchPixels(this.layerView.view.extent,this.layerView.view.width,this.layerView.view.height,{...t,interpolation:"nearest",requestRawData:!1,skipRasterFunction:!1});if(!i?.pixelBlock)return;const{resolution:s}=this.previousLOD,{isBsqTile:r}=this.layer.raster.rasterInfo.storageInfo,n=r?null:this._getBandIds(),o=this.layer.symbolizer.generateWebGLParameters({pixelBlock:i.pixelBlock.extractBands(n),isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:s,y:s},bandIds:n});!this.canUseWebGLForProcessing&&o&&"stretch"===o.type&&this.layer.renderer&&"raster-stretch"===this.layer.renderer.type&&(o.factor=o.factor.map(e=>255*e),o.minOutput=Math.round(255*o.minOutput),o.maxOutput=Math.round(255*o.maxOutput)),this._globalSymbolizerParams=o}_updateSymbolizerParams(){const{resolution:e}=this.previousLOD,t=this._getBandIds();this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:t})}_updateBlockCacheRegistry(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const{layer:t,layerView:i}=this,{raster:s}=t,{multidimensionalDefinition:r}=t.normalizeRasterFetchOptions({multidimensionalDefinition:t.multidimensionalDefinition,timeExtent:i.timeExtent}),n=s.rasterInfo.multidimensionalInfo?s.getSliceIndex(r):null,o=s.rasterInfo.storageInfo.isBsqTile?t.getRawDisplayBandIds():null,a=(0,si.ph)(s.rasterId,n,o);if(a!==this._blockCacheRegistryUrl){if(null!=this._blockCacheRegistryUrl&&(0,si.ht)(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=(0,si.kz)(a,s.rasterInfo),e){const{view:e}=i,t=this._tileInfoView.getClosestInfoForScale(e.scale),r=this._srcResolutions[t.level];(0,si.yo)(a,this._blockCacheRegistryId,e.extent,e.resolution,r,s.ioConfig.sampling)}this._blockCacheRegistryUrl=a}}async doRefresh(){if(!this.attached||!this.previousLOD||this.layerView.suspended)return;await this.layer.updateRenderer(),this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();const e=[];this._globalUpdateRequested=this.isCPUBasedDRA||!this.useProgressiveUpdate,this._tileStrategy.refresh(t=>e.push(this._enqueueTileFetch(t))),await this._updatingHandles.addPromise(Promise.allSettled(e))}};(0,s.Cg)([(0,l.MZ)()],ci.prototype,"_globalUpdateRequested",void 0),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"attached",void 0),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"canUseWebGLForProcessing",null),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"canUseLocalSymbolizerParams",null),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"isCPUBasedDRA",null),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"container",void 0),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"layer",void 0),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"layerView",void 0),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"scheduler",void 0),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"type",void 0),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"useWebGLForProcessing",null),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"useProgressiveUpdate",null),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"timeExtent",void 0),(0,s.Cg)([(0,l.MZ)()],ci.prototype,"updating",null),ci=(0,s.Cg)([(0,c.$)("esri.views.2d.layers.imagery.BaseImageryTileSubView2D")],ci);var hi=i(13692),di=i(1723),pi=i(1898);let mi=class extends ci{constructor(){super(...arguments),this.type="raster"}get canUseWebGLForProcessing(){const{loaded:e,symbolizer:t}=this.layer;if(!e||!t)return!1;const i=t.lookup.colormapLut?.indexedColormap,s=i&&i.length>this._maxIndexedColormapSize,r=(0,y.xN)(this.layer.serviceRasterInfo);return!((0,u.A)("ios")&&r>4)&&this.useWebGLForProcessing&&t.canRenderInWebGL&&!s&&!("majority"===this.layer.interpolation&&(0,hi.H_)(this.layer))}attach(){super.attach(),this.container=new $t(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this.updateRasterFunctionParameters()}detach(){super.detach(),this.container.removeAllChildren(),this.container=null}fetchTile(e,t){return this.layer.fetchTile(e.level,e.row,e.col,t)}updateRasterFunctionParameters(){const{raster:e,type:t}=this.layer,{container:i}=this;if("Function"!==e.datasetFormat||"wcs"===t)return i.rasterFunctionChain=null,i.children.forEach(e=>{const{bitmap:t}=e;t&&(t.suspended=!0,t.processed=!1,t.projected&&(t.invalidateTexture(),t.rasterTexture=null))}),void(this._rasterFunctionState="na");const s=this._rasterFunctionState,{rasterFunction:r,primaryRasters:n}=e,o=r.supportsGPU&&(!n||n.rasters.length<=1),a=o?r.flatWebGLFunctionChain:null,{renderer:l}=this.layer,u=!o||!a?.functions.length||"raster-stretch"===l?.type&&l.dynamicRangeAdjustment||!this.canUseWebGLForProcessing;i.rasterFunctionChain=u?null:this._addProjection(a);const c=null==r?"na":i.rasterFunctionChain?"gpu":"cpu",h=s===c||"na"===s&&"cpu"===c&&0===a?.functions?.length;i.children.forEach(e=>{const{bitmap:t}=e;t&&(t.suspended=!h,t.processed=!1,t.processedTexture=null)}),this._rasterFunctionState=c}async updateTileSource(e,t){const i=this._getBandIds(),s=this._getLayerInterpolation(),{canUseWebGLForProcessing:r}=this,{source:n,globalSymbolizerParams:o,suspended:a,coords:l,resolution:u}=t,c=this.isCPUBasedDRA?o:t.symbolizerParams,{bitmap:h}=e;if([h.x,h.y]=l,h.resolution=u,null!=n?.pixelBlock){const e={extent:n.extent,pixelBlock:n.pixelBlock,srcPixelSize:n.srcTilePixelSize};if(h.rawPixelData=e,r)h.source=n.pixelBlock,h.isRendereredSource=!1;else{const t=await this.layer.applyRenderer(e,"stretch"===o?.type?o:void 0);h.source=t,h.isRendereredSource=!0}h.symbolizerParameters=r?c:null,h.transformGrid=r?n.transformGrid:null}else{const e=this.createEmptyTilePixelBlock();h.source=e,h.symbolizerParameters=r?c:null,h.transformGrid=null}const{isBsqTile:d}=this.layer.raster.rasterInfo.storageInfo;h.bandIds=r&&!d?i:null,h.width=this._tileInfoView.tileInfo.size[0],h.height=this._tileInfoView.tileInfo.size[1],h.interpolation=s,h.suspended=a;const{raster:p}=this.layer;if((0,f.qg)(p)){const t=p.getClippingGeometry(this.layerView.view.spatialReference);if(t){const i=p.getTileExtentFromTileInfo(e.key.level,e.key.row,e.key.col,this._tileInfoView.tileInfo);i&&(h.mask=(0,x.b5)({srcExtent:i,geometry:t,size:[h.width,h.height]}))}}h.invalidateTexture()}async updateTileSymbolizerParameters(e,t,i){const{local:s,global:r}=t,n=this._getBandIds(),o=this._getLayerInterpolation(),{canUseWebGLForProcessing:a}=this,{bitmap:l}=e,{rawPixelData:u}=l;a||null==u?(l.isRendereredSource&&null!=u&&(l.source=u.pixelBlock),l.isRendereredSource=!1):(l.source=await this.layer.applyRenderer(u,"stretch"===r?.type?r:void 0,{signal:i}),l.isRendereredSource=!0),l.symbolizerParameters=a?this.layerView.hasTilingEffects?r:s:null;const{isBsqTile:c}=this.layer.raster.rasterInfo.storageInfo;l.bandIds=a&&!c?n:null,l.interpolation=o,l.suspended=!1}updateHighlightOptions(e){if(!e.length)return void(this.container.pixelHighlights=void 0);const t=[],{highlights:i}=this.layerView.view;e.sort((e,t)=>i.findIndex(e=>{let{name:i}=e;return i===(0,pi.i)(t.options)})-i.findIndex(t=>{let{name:i}=t;return i===(0,pi.i)(e.options)}));for(const{target:s,options:r}of e){const{pixelRanges:e}=s,n=Array.from({length:2*b.et},()=>0);for(let t=0;t<e.length;t++)n[2*t]=e[t][0],n[2*t+1]=e[t][1];for(let t=e.length;t<b.et;t++)n[2*t]=g.pq,n[2*t+1]=-g.pq;const o=s.bandId??0,a=(0,pi.i)(r),l=i.find(e=>e.name===a)?.color??di.fT,u=m.A.toUnitRGBA(l);t.push({ranges:n,bandId:o,color:u})}this.container.pixelHighlights=t}_getLayerInterpolation(){const{interpolation:e,renderer:t}=this.layer;if(!t)return e;const i=t.type;return"raster-colormap"===i||"unique-value"===i?"nearest":"raster-stretch"===t.type&&null!=t.colorRamp?"bilinear"===e||"cubic"===e?"bilinear":"nearest":e}_addProjection(e){return e?.functions?.length&&!e.hasFocalFunction&&e.functions.unshift({name:"Reproject",parameters:{targetImageSize:this._tileInfoView.tileInfo.size,requireNNEdge:e.isSourceSingleBand},pixelType:"f32",id:0,isNoopProcess:!1}),e}};(0,s.Cg)([(0,l.MZ)()],mi.prototype,"canUseWebGLForProcessing",null),(0,s.Cg)([(0,l.MZ)()],mi.prototype,"container",void 0),(0,s.Cg)([(0,l.MZ)()],mi.prototype,"layer",void 0),(0,s.Cg)([(0,l.MZ)()],mi.prototype,"type",void 0),mi=(0,s.Cg)([(0,c.$)("esri.views.2d.layers.imagery.ImageryTileView2D")],mi);var gi=i(99846),fi=i(17331),yi=i(86386);class xi extends k.Y{constructor(e,t,i,s,r,n){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;super(e,t,i,s,r,n),this.tileData=new yi.X(o),this.tileData.coordScale=[r,n],this.tileData.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(e){this.tileData.stencilRef=e}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{displayViewScreenMat3:(0,_.vt)(),tileMat3:(0,_.vt)()}}setTransform(e){super.setTransform(e);const t=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[s,r]=this.tileData.offset,n=[this.x+s*this.resolution,this.y-r*this.resolution],[o,a]=e.toScreenNoRotation([0,0],n),{symbolTileSize:l}=this.tileData.symbolizerParameters,u=Math.round((this.width-this.tileData.offset[0])/l)*l,c=Math.round((this.height-this.tileData.offset[1])/l)*l,h=u/this.rangeX*t,d=c/this.rangeY*t;(0,T.hZ)(i,h,0,0,0,d,0,o,a,1),(0,T.lw)(this.transforms.displayViewScreenMat3,e.displayViewMat3,i),this.tileData.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}}class bi extends I.A{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=["triangle"]}createTile(e){const t=this.tileInfoView.getTileBounds((0,w.vt)(),e),[i,s]=this.tileInfoView.tileInfo.size,r=this.tileInfoView.getTileResolution(e.level);return new xi(e,r,t[0],t[3],i,s)}prepareRenderPasses(e){const t=e.registerRenderPass({name:"imagery (vf tile)",brushes:[fi.A],target:()=>this.children.map(e=>e.tileData),drawPhase:1});return[...super.prepareRenderPasses(e),t]}doRender(e){this.visible&&1===e.drawPhase&&this.symbolTypes.forEach(t=>{e.renderPass=t,super.doRender(e)})}}let wi=class extends ci{constructor(){super(...arguments),this._handle=null,this.type="rasterVF"}async fetchTile(e,t){t={...t,interpolation:"nearest",requestProjectedLocalDirections:!0};const i=await this.layer.fetchTile(e.level,e.row,e.col,t);return"vector-magdir"===this.layer.serviceRasterInfo?.dataType&&i?.pixelBlock&&(i.pixelBlock=await this.layer.convertVectorFieldData(i.pixelBlock,"vector-magdir",t)),i}updateTileSource(e,t){const i=t.symbolizerParams,{tileData:s}=e;s.key=e.key,s.width=this._tileInfoView.tileInfo.size[0],s.height=this._tileInfoView.tileInfo.size[1];const{symbolTileSize:r}=i,{source:n}=t;if(s.offset=this._getTileSymbolOffset(s.key,r),null!=n?.pixelBlock){const e={extent:n.extent,pixelBlock:n.pixelBlock};s.rawPixelData=e,s.symbolizerParameters=i,s.source=this._sampleVectorFieldData(n.pixelBlock,i,s.offset)}else{const e=[Math.round((this._tileInfoView.tileInfo.size[0]-s.offset[0])/r),Math.round((this._tileInfoView.tileInfo.size[1]-s.offset[1])/r)],t=this.createEmptyTilePixelBlock(e);s.source=t,s.symbolizerParameters=i}return s.invalidateVAO(),Promise.resolve()}updateTileSymbolizerParameters(e,t){const i=t.local,{symbolTileSize:s}=i,{tileData:r}=e;r.offset=this._getTileSymbolOffset(r.key,s);const n=r.symbolizerParameters.symbolTileSize;r.symbolizerParameters=i;const o=r.rawPixelData?.pixelBlock;return null!=o&&n!==s&&(r.source=this._sampleVectorFieldData(o,r.symbolizerParameters,r.offset)),Promise.resolve()}attach(){super.attach(),this.container=new bi(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=(0,a.wB)(()=>this.layer.renderer,e=>this._updateSymbolType(e))}detach(){super.detach(),this.container.removeAllChildren(),this._handle?.remove(),this._handle=null,this.container=null}_getTileSymbolOffset(e,t){const i=e.col*this._tileInfoView.tileInfo.size[0]%t,s=e.row*this._tileInfoView.tileInfo.size[1]%t;return[i>t/2?t-i:-i,s>t/2?t-s:-s]}_sampleVectorFieldData(e,t,i){const{symbolTileSize:s}=t;return(0,gi.Wu)(e,"vector-uv",s,i)}_updateSymbolType(e){"vector-field"===e?.type&&(this.container.symbolTypes="wind-barb"===e.style?["scalar","triangle"]:"simple-scalar"===e.style?["scalar"]:["triangle"])}};(0,s.Cg)([(0,l.MZ)()],wi.prototype,"container",void 0),(0,s.Cg)([(0,l.MZ)()],wi.prototype,"layer",void 0),(0,s.Cg)([(0,l.MZ)()],wi.prototype,"type",void 0),wi=(0,s.Cg)([(0,c.$)("esri.views.2d.layers.imagery.VectorFieldTileView2D")],wi);var Ci=i(39356),_i=i(50076),vi=i(51939),Ti=i(31516),Pi=i(2257);const Si=e=>{const t=e;let i=class extends t{constructor(){super(...arguments),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){return(0,Ti.F)(this.layer,this.view?.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){const{renderer:e}=this.layer;return!("raster-stretch"!==e?.type||!e.dynamicRangeAdjustment||"min-max"===e.stretchType||"standard-deviation"===e.stretchType)}get datumTransformation(){try{return this.layer.loaded?(0,ri.vI)(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(e){try{return!this.layer.loaded||!!(0,ri.eh)(this.layer.serviceRasterInfo,e)}catch{return!1}}async fetchPopupFeaturesAtLocation(e,t){const{layer:i}=this;if(!e)throw new _i.A("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:i});const{popupEnabled:s}=i,r=(0,Pi.D8)(i,t);if(!s||null==r)return[];const n=[],{value:o,magdirValue:a,processedValue:l}=await i.identify(e,{timeExtent:this.timeExtent,signal:t?.signal});let u="";if(o?.length){u="imagery-tile"===i.type&&i.hasStandardTime()&&null!=o[0]?o.map(e=>i.getStandardTimeValue(e)).join(", "):o.join(", ");const e={ObjectId:0};e[vi.F_.servicePixelValue]="imagery-tile"===i.type&&(0,f.qg)(i.raster)?l?.join(", "):u,e[vi.F_.rawServicePixelValue]=u;const t=i.raster?.rasterInfo??i.serviceRasterInfo,s=t?.attributeTable;if(null!=s){const{fields:t,features:i}=s,r=t.find(e=>{let{name:t}=e;return"value"===t.toLowerCase()}),n=e[vi.F_.servicePixelValue],o=r?i.find(e=>String(e.attributes[r.name])===n):null;if(o)for(const s in o.attributes)o.attributes.hasOwnProperty(s)&&(e[vi.ER+s]=o.attributes[s])}const r=t?.dataType;"vector-magdir"!==r&&"vector-uv"!==r||(e[vi.F_.magnitude]=a?.[0],e[vi.F_.direction]=a?.[1]);const{multidimensionalDefinition:c}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});(0,vi.eS)(i.rasterFields,e,c);const{graphicOrigin:h}=i,d=new Ci.A({geometry:this.fullExtent?.clone(),attributes:e,layer:i,origin:h,sourceLayer:i});n.push(d)}return n}async getSourceScale(){return await this.layer.load(),(0,ri.OO)(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return(0,ri.eh)(this.layer.serviceRasterInfo,this.view.spatialReference)}};return(0,s.Cg)([(0,l.MZ)()],i.prototype,"fullExtent",null),(0,s.Cg)([(0,l.MZ)()],i.prototype,"layer",void 0),(0,s.Cg)([(0,l.MZ)({readOnly:!0})],i.prototype,"timeExtent",null),(0,s.Cg)([(0,l.MZ)()],i.prototype,"tileInfo",void 0),(0,s.Cg)([(0,l.MZ)({readOnly:!0})],i.prototype,"hasTilingEffects",null),(0,s.Cg)([(0,l.MZ)()],i.prototype,"datumTransformation",null),i=(0,s.Cg)([(0,c.$)("esri.views.layers.ImageryTileLayerView")],i),i};var Ri=i(91196),Mi=i(771);let zi=class extends(Si((0,Mi.I)((0,p.e)(Ri.A)))){constructor(){super(...arguments),this._useWebGLForProcessing=!0,this._useProgressiveUpdate=!0,this._pixelHighlights=[],this.subview=null}get useWebGLForProcessing(){return this._useWebGLForProcessing}set useWebGLForProcessing(e){this._useWebGLForProcessing=e,this.subview&&"useWebGLForProcessing"in this.subview&&(this.subview.useWebGLForProcessing=e)}get useProgressiveUpdate(){return this._useWebGLForProcessing}set useProgressiveUpdate(e){this._useProgressiveUpdate=e,this.subview&&"useProgressiveUpdate"in this.subview&&(this.subview.useProgressiveUpdate=e)}get displayParameters(){const{layer:e}=this,t=this._get("displayParameters");return e.renderer&&e.visible?{bandIds:e.bandIds,renderer:e.renderer,interpolation:e.interpolation,multidimensionalDefinition:e.multidimensionalDefinition,rasterFunction:"imagery-tile"===e.type?e.rasterFunction:null}:t}update(e){this.subview?.update(e),this.notifyChange("updating")}isUpdating(){return!this.subview||this.subview.updating}attach(){this.layer.increaseRasterJobHandlerUsage(),this._updateSubview(),this.addAttachHandles([(0,a.wB)(()=>this.displayParameters,(e,t)=>{const i=e.interpolation!==t?.interpolation&&("majority"===e.interpolation||"majority"===t?.interpolation)&&(0,hi.H_)(this.layer),s=!!this.layer.serviceRasterInfo?.storageInfo?.isBsqTile&&e.bandIds?.join()!==t?.bandIds?.join(),r=e.renderer!==t?.renderer&&this._getSubviewType(t?.renderer)!==this._getSubviewType(e.renderer);r&&this._updateSubview();const a=e.multidimensionalDefinition!==t?.multidimensionalDefinition,l=e.rasterFunction!==t?.rasterFunction,u=l&&!this._useWebGLForProcessing,c=a||i||r||u||s;this.subview.redrawOrRefetch({refetch:c,reprocess:l}).catch(e=>{(0,o.zf)(e)||n.A.getLogger(this).error(e)}),this.notifyChange("updating")}),(0,a.wB)(()=>this.layer.multidimensionalSubset??null,(e,t)=>{const{multidimensionalDefinition:i}=this.layer;null!=i&&(0,h.sx)(i,e)!==(0,h.sx)(i,t)&&(this.subview.redrawOrRefetch({refetch:!0}).catch(e=>{(0,o.zf)(e)||n.A.getLogger(this).error(e)}),this.notifyChange("updating"))},a.OH),(0,a.wB)(()=>this.timeExtent,()=>{this.subview.timeExtent=this.timeExtent,this.subview.redrawOrRefetch({refetch:!0}).catch(e=>{(0,o.zf)(e)||n.A.getLogger(this).error(e)})},a.Vh),(0,a.wB)(()=>this.view.highlights.items.map(e=>{let{name:t,color:i}=e;return{name:t,color:i}}),()=>this._updateHighlightOptions(this.subview),a.Vh)])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}viewChange(){this.requestUpdate()}moveEnd(){this.subview.moveEnd()}highlight(e,t){if(!e.pixelRanges?.length)return(0,r.hA)();const i={target:{...e},options:{...t}};return this._pixelHighlights.push(i),this._updateHighlightOptions(this.subview),(0,r.hA)(()=>{const e=this._pixelHighlights.indexOf(i);-1!==e&&(this._pixelHighlights.splice(e,1),this._updateHighlightOptions(this.subview))})}doRefresh(){return this.subview?this.subview.doRefresh():Promise.resolve()}_updateSubview(){const{renderer:e}=this.layer;if(!e)return;const t=this._getSubviewType(e);if(this.subview){if(this.subview.type===t)return void this._attachSubview(this.subview);this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}const{layer:i}=this;let s;if(s="rasterVF"===t?new wi({layer:i,layerView:this,scheduler:this.scheduler}):"flow"===t?new d.A({layer:i,layerView:this,scheduler:this.scheduler}):new mi({layer:i,layerView:this,scheduler:this.scheduler}),"useWebGLForProcessing"in s&&(s.useWebGLForProcessing=this._useWebGLForProcessing),"useProgressiveUpdate"in s&&(s.useProgressiveUpdate=this._useProgressiveUpdate),"previousLOD"in s){const{subview:e}=this;s.previousLOD=e&&"previousLOD"in e?e.previousLOD:null}this._attachSubview(s),this._updateHighlightOptions(s),this.subview=s,this.requestUpdate()}_attachSubview(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0))}_detachSubview(e){e?.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)}_getSubviewType(e){const t=e?.type;return"vector-field"===t?"rasterVF":"flow"===t?"flow":"raster"}_updateHighlightOptions(e){"raster"===e?.type&&e.updateHighlightOptions(this._pixelHighlights)}};(0,s.Cg)([(0,l.MZ)()],zi.prototype,"subview",void 0),(0,s.Cg)([(0,l.MZ)()],zi.prototype,"useWebGLForProcessing",null),(0,s.Cg)([(0,l.MZ)()],zi.prototype,"useProgressiveUpdate",null),(0,s.Cg)([(0,l.MZ)({readOnly:!0})],zi.prototype,"displayParameters",null),zi=(0,s.Cg)([(0,c.$)("esri.views.2d.layers.ImageryTileLayerView2D")],zi);const ki=zi}}]);
//# sourceMappingURL=1449.89cfbf35.chunk.js.map